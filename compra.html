<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Confirmar Compra - Rifa Moto 0KM</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .resumen-ticket { background: #f8f9fa; border-radius: 10px; padding: 20px; }
    .ticket-badge { background: #28a745; color: white; padding: 8px 12px; border-radius: 5px; display: inline-block; margin: 5px; font-weight: bold; }
    .creditos-info { background: #e8f4fd; border-left: 4px solid #007bff; padding: 15px; margin: 15px 0; border-radius: 5px; }
    .metodo-pago { border: 2px solid #e9ecef; border-radius: 10px; padding: 15px; margin: 10px 0; cursor: pointer; transition: all 0.3s; }
    .metodo-pago:hover { border-color: #007bff; }
    .metodo-pago.selected { border-color: #007bff; background: #f8f9ff; }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-primary">
    <div class="container">
      <span class="navbar-brand">🏍️ Confirmar Compra</span>
      <a href="/" class="btn btn-outline-light btn-sm">← Volver</a>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="row">
      <div class="col-md-8">
        <div class="card">
          <div class="card-header">
            <h4 class="mb-0">👤 Información Personal</h4>
          </div>
          <div class="card-body">
            <form id="formCompra">
              <!-- Campo oculto para userId (deberías obtenerlo de la sesión) -->
              <input type="hidden" id="userId" value="5"> <!-- Cambia esto por el ID real del usuario -->
              
              <div class="creditos-info" id="creditosInfo">
                <h6>💳 Créditos Disponibles</h6>
                <p>Cargando información de créditos...</p>
              </div>
              
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Nombre completo *</label>
                    <input type="text" class="form-control" id="nombre" required>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Teléfono *</label>
                    <input type="tel" class="form-control" id="telefono" required>
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Email (opcional)</label>
                <input type="email" class="form-control" id="email">
              </div>

              <h5 class="mt-4">💳 Método de Pago</h5>
              
              <div class="metodo-pago selected">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="metodoPago" id="pago_creditos" value="creditos" checked>
                  <label class="form-check-label fw-bold" for="pago_creditos">
                    ⭐ Pagar con Créditos
                  </label>
                </div>
                <div class="mt-2">
                  <p class="mb-1"><small>Los créditos se descontarán automáticamente de tu cuenta.</small></p>
                  <p class="mb-0 text-success"><strong>✅ Pago instantáneo - Sin verificación manual</strong></p>
                </div>
              </div>

              <div class="alert alert-info mt-3">
                <h6>📋 Resumen de Pago con Créditos:</h6>
                <div class="row">
                  <div class="col-6">
                    <small>Tickets seleccionados:</small>
                    <div id="resumenCantidadCredito">0</div>
                  </div>
                  <div class="col-6">
                    <small>Total en créditos:</small>
                    <div class="fw-bold" id="resumenTotalCredito">0</div>
                  </div>
                </div>
              </div>

              <div class="mt-4">
                <button type="submit" class="btn btn-success btn-lg w-100" id="btnConfirmar">
                  ✅ Confirmar Compra con Créditos
                </button>
                <div id="errorMensaje" class="alert alert-danger mt-2" style="display: none;"></div>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="resumen-ticket">
          <h5>📋 Resumen de Compra</h5>
          <div class="mb-3">
            <strong>Tickets seleccionados:</strong>
            <div id="resumenTickets" class="mt-2"></div>
          </div>
          <div class="mb-2">
            <strong>Cantidad:</strong> <span id="resumenCantidad">0</span> tickets
          </div>
          <div class="mb-2">
            <strong>Precio unitario:</strong> <span id="precioUnitario">100 créditos</span>
          </div>
          <div class="mb-3">
            <strong>Total a pagar:</strong> 
            <h4 class="text-success"><span id="resumenTotal">0</span> créditos</h4>
          </div>
        </div>

        <div class="alert alert-warning mt-3">
          <small>
            ⚠️ <strong>Importante:</strong><br>
            • La compra se procesa instantáneamente con tus créditos<br>
            • Los tickets se asignan automáticamente a tu cuenta<br>
            • Puedes ver tus tickets en "Mis Tickets"
          </small>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Variables globales
    let ticketsSeleccionados = [];
    let precioPorTicket = 100;
    let creditosUsuario = 0;
    let userId = 5; // Cambiar por el ID real del usuario logueado

    // Obtener tickets de la URL
    function obtenerTicketsDeURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const ticketsParam = urlParams.get('tickets');
      
      if (ticketsParam) {
        ticketsSeleccionados = ticketsParam.split(',').map(t => t.trim());
        actualizarResumen();
        cargarInfoCreditos();
      } else {
        // Si no hay tickets en la URL, redirigir
        window.location.href = '/';
      }
    }

    // Cargar información de créditos
    async function cargarInfoCreditos() {
      try {
        const response = await fetch('/api/verificar-creditos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: userId })
        });
        
        const data = await response.json();
        
        if (data.success) {
          creditosUsuario = data.data.creditosDisponibles;
          precioPorTicket = data.data.precioPorTicket;
          
          // Actualizar UI
          document.getElementById('creditosInfo').innerHTML = `
            <h6>💳 Créditos Disponibles</h6>
            <p><strong>${creditosUsuario} créditos</strong> disponibles</p>
            <p class="mb-0"><small>Precio por ticket: ${precioPorTicket} créditos</small></p>
          `;
          
          document.getElementById('precioUnitario').textContent = `${precioPorTicket} créditos`;
          actualizarResumen();
        }
      } catch (error) {
        console.error('Error cargando créditos:', error);
      }
    }

    // Actualizar resumen
    function actualizarResumen() {
      const cantidad = ticketsSeleccionados.length;
      const totalCreditos = cantidad * precioPorTicket;
      
      // Actualizar UI
      document.getElementById('resumenCantidad').textContent = cantidad;
      document.getElementById('resumenTotal').textContent = totalCreditos;
      
      document.getElementById('resumenCantidadCredito').textContent = `${cantidad} tickets`;
      document.getElementById('resumenTotalCredito').textContent = `${totalCreditos} créditos`;
      
      // Actualizar lista de tickets
      const ticketsHTML = ticketsSeleccionados.map(ticket => 
        `<span class="ticket-badge">${ticket}</span>`
      ).join('');
      document.getElementById('resumenTickets').innerHTML = ticketsHTML;
      
      // Verificar si tiene créditos suficientes
      const btnConfirmar = document.getElementById('btnConfirmar');
      if (creditosUsuario < totalCreditos) {
        btnConfirmar.disabled = true;
        btnConfirmar.innerHTML = '❌ Créditos Insuficientes';
        document.getElementById('errorMensaje').style.display = 'block';
        document.getElementById('errorMensaje').innerHTML = 
          `No tienes suficientes créditos. Necesitas ${totalCreditos} créditos, pero solo tienes ${creditosUsuario}.`;
      } else {
        btnConfirmar.disabled = false;
        btnConfirmar.innerHTML = '✅ Confirmar Compra con Créditos';
        document.getElementById('errorMensaje').style.display = 'none';
      }
    }

    // Procesar compra
    async function procesarCompra(event) {
      event.preventDefault();
      
      const nombre = document.getElementById('nombre').value;
      const telefono = document.getElementById('telefono').value;
      const email = document.getElementById('email').value;
      const cantidad = ticketsSeleccionados.length;
      const totalCreditos = cantidad * precioPorTicket;
      
      if (!nombre || !telefono) {
        alert('Por favor completa todos los campos obligatorios');
        return;
      }
      
      if (creditosUsuario < totalCreditos) {
        alert('No tienes suficientes créditos para realizar esta compra');
        return;
      }
      
      // Deshabilitar botón para evitar doble clic
      const btnConfirmar = document.getElementById('btnConfirmar');
      btnConfirmar.disabled = true;
      btnConfirmar.innerHTML = '⏳ Procesando compra...';
      
      try {
        const response = await fetch('/api/comprar-tickets', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: userId,
            nombre: nombre,
            telefono: telefono,
            email: email,
            tickets: ticketsSeleccionados.join(','),
            totalCreditos: totalCreditos
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Redirigir a página de éxito
          window.location.href = `/compra-exitosa.html?orden=${data.data.ordenId}&tickets=${ticketsSeleccionados.join(',')}`;
        } else {
          alert('Error: ' + data.error);
          btnConfirmar.disabled = false;
          btnConfirmar.innerHTML = '✅ Confirmar Compra con Créditos';
        }
      } catch (error) {
        console.error('Error procesando compra:', error);
        alert('Error al procesar la compra. Por favor intenta nuevamente.');
        btnConfirmar.disabled = false;
        btnConfirmar.innerHTML = '✅ Confirmar Compra con Créditos';
      }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      obtenerTicketsDeURL();
      document.getElementById('formCompra').addEventListener('submit', procesarCompra);
    });
  </script>
</body>
</html>