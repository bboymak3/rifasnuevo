<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Juego de Dados - Sistema de Rifas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white;
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .navbar {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
    }
    
    .dado {
      width: 100px;
      height: 100px;
      background: white;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      font-weight: bold;
      color: #1a1a2e;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      margin: 10px;
      position: relative;
      overflow: hidden;
    }
    
    .dado::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: #1a1a2e;
      border-radius: 50%;
      opacity: 0.2;
    }
    
    .dado-container {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 30px 0;
    }
    
    .player-area {
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 30px;
      margin: 20px 0;
      border: 2px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
    }
    
    .rolling {
      animation: roll 1s ease-in-out infinite;
    }
    
    @keyframes roll {
      0% { transform: rotate(0deg) scale(1); }
      25% { transform: rotate(90deg) scale(1.1); }
      50% { transform: rotate(180deg) scale(1.2); }
      75% { transform: rotate(270deg) scale(1.1); }
      100% { transform: rotate(360deg) scale(1); }
    }
    
    .resultado {
      font-size: 1.8rem;
      font-weight: bold;
      padding: 25px;
      border-radius: 15px;
      margin: 30px 0;
      text-align: center;
      backdrop-filter: blur(10px);
      animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .ganador {
      background: rgba(40, 167, 69, 0.3);
      border: 2px solid #28a745;
      color: #28a745;
    }
    
    .perdedor {
      background: rgba(220, 53, 69, 0.3);
      border: 2px solid #dc3545;
      color: #dc3545;
    }
    
    .empate {
      background: rgba(255, 193, 7, 0.3);
      border: 2px solid #ffc107;
      color: #ffc107;
    }
    
    .apuesta-control {
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 30px;
      margin: 30px 0;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255,255,255,0.2);
    }
    
    .btn-dados {
      background: linear-gradient(45deg, #ff6b6b, #ee5a24);
      color: white;
      border: none;
      padding: 18px 40px;
      font-size: 1.3rem;
      font-weight: bold;
      border-radius: 12px;
      transition: all 0.3s;
      width: 100%;
    }
    
    .btn-dados:hover:not(:disabled) {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(238, 90, 36, 0.4);
    }
    
    .btn-dados:disabled {
      background: #6c757d;
      transform: none;
      box-shadow: none;
      opacity: 0.7;
    }
    
    .creditos-badge {
      background: linear-gradient(45deg, #ffd700, #ff9800);
      color: #1a1a2e;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: bold;
      font-size: 1.2rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .historial-item {
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      border-left: 4px solid;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .historial-ganador {
      border-left-color: #28a745;
    }
    
    .historial-perdedor {
      border-left-color: #dc3545;
    }
    
    .historial-empate {
      border-left-color: #ffc107;
    }
    
    .puntos-total {
      font-size: 3rem;
      font-weight: bold;
      text-shadow: 0 5px 15px rgba(0,0,0,0.3);
      margin: 10px 0;
    }
    
    .usuario-total {
      color: #4fc3f7;
    }
    
    .computadora-total {
      color: #ff5252;
    }
    
    @media (max-width: 768px) {
      .dado {
        width: 70px;
        height: 70px;
        font-size: 2rem;
      }
      
      .dado-container {
        gap: 15px;
      }
      
      .puntos-total {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        🎲 <span>Juego de Dados</span>
      </a>
      <div class="d-flex align-items-center gap-3">
        <div class="creditos-badge" id="creditosBadge">
          💰 <span id="userCredits">0</span> créditos
        </div>
        <button class="btn btn-outline-light btn-sm" onclick="window.location.href='index.html'">
          🏠 Inicio
        </button>
        <button class="btn btn-warning btn-sm" onclick="window.location.href='recargar-creditos.html'">
          💳 Recargar
        </button>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <!-- Información del usuario -->
        <div class="text-center mb-4">
          <h4 class="mb-2">👤 <span id="userName">Jugador</span></h4>
          <p class="text-muted" id="userEmail">usuario@ejemplo.com</p>
        </div>

        <!-- Controles de Apuesta -->
        <div class="apuesta-control">
          <h4 class="text-center mb-4">🎯 Control de Apuesta</h4>
          <div class="row align-items-center">
            <div class="col-md-7">
              <label class="form-label fw-bold mb-3">Cantidad a Apostar</label>
              <div class="d-flex align-items-center gap-3">
                <input type="range" class="form-range" id="apuestaRange" 
                       min="10" max="500" value="50" step="10">
                <div class="input-group" style="width: 150px;">
                  <span class="input-group-text">💰</span>
                  <input type="number" class="form-control text-center" id="apuestaInput" 
                         min="10" max="500" value="50">
                </div>
              </div>
              <div class="d-flex justify-content-between mt-2">
                <small class="text-muted">Mín: <span id="apuestaMin">10</span> créditos</small>
                <small class="text-muted">Máx: <span id="apuestaMax">500</span> créditos</small>
              </div>
              <div class="mt-3">
                <small class="text-muted">Créditos después de apuesta: </small>
                <strong class="text-warning" id="creditosDespues">0</strong>
              </div>
            </div>
            <div class="col-md-5">
              <button class="btn btn-dados btn-lg" id="btnJugar" onclick="jugarDados()">
                🎲 JUGAR DADOS
              </button>
              <div class="text-center mt-3">
                <button class="btn btn-outline-light btn-sm" onclick="apuestaRapida(100)">
                  Apostar 100
                </button>
                <button class="btn btn-outline-light btn-sm ms-2" onclick="apuestaRapida(500)">
                  Apostar 500
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Área de Juego -->
        <div class="player-area">
          <div class="row">
            <!-- Jugador -->
            <div class="col-md-6 mb-4 mb-md-0">
              <h5 class="text-info mb-3">👤 TUS DADOS</h5>
              <div class="dado-container">
                <div class="dado" id="usuarioDado1">?</div>
                <div class="dado" id="usuarioDado2">?</div>
              </div>
              <div class="text-center mt-3">
                <div class="puntos-total usuario-total" id="usuarioTotal">0</div>
                <small class="text-muted">Total de puntos</small>
              </div>
            </div>

            <!-- Computadora -->
            <div class="col-md-6">
              <h5 class="text-danger mb-3">🤖 COMPUTADORA</h5>
              <div class="dado-container">
                <div class="dado" id="computadoraDado1">?</div>
                <div class="dado" id="computadoraDado2">?</div>
              </div>
              <div class="text-center mt-3">
                <div class="puntos-total computadora-total" id="computadoraTotal">0</div>
                <small class="text-muted">Total de puntos</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Resultado -->
        <div class="resultado" id="resultadoDiv" style="display: none;">
          <div id="resultadoTexto"></div>
          <div id="resultadoDetalle" class="mt-2"></div>
        </div>

        <!-- Historial de Partidas -->
        <div class="mt-5" id="historialContainer" style="display: none;">
          <h4 class="text-center mb-4">📋 Historial de Partidas</h4>
          <div id="historialLista">
            <!-- Historial se llenará con JavaScript -->
          </div>
        </div>

        <!-- Botones de Acción -->
        <div class="text-center mt-4" id="accionesDiv" style="display: none;">
          <button class="btn btn-dados me-2" id="btnNuevaRonda" onclick="jugarDados()">
            🔄 Jugar Otra Ronda
          </button>
          <button class="btn btn-outline-light" onclick="resetJuego()">
            🏁 Nuevo Juego
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let usuario = null;
    let historialJuegos = [];
    let juegoActivo = false;

    // Inicializar juego
    document.addEventListener('DOMContentLoaded', function() {
      verificarSesion();
      configurarControlesApuesta();
    });

    // Verificar sesión
    function verificarSesion() {
      const isLoggedIn = localStorage.getItem('isLoggedIn');
      const userDataStr = localStorage.getItem('user');
      
      if (isLoggedIn !== 'true' || !userDataStr) {
        alert('Debes iniciar sesión para jugar a los dados');
        window.location.href = 'login.html';
        return;
      }
      
      try {
        usuario = JSON.parse(userDataStr);
        mostrarInfoUsuario();
        actualizarCreditosDespues();
      } catch (error) {
        console.error('Error cargando usuario:', error);
        window.location.href = 'login.html';
      }
    }

    // Mostrar información del usuario
    function mostrarInfoUsuario() {
      document.getElementById('userName').textContent = usuario.nombre;
      document.getElementById('userEmail').textContent = usuario.email;
      document.getElementById('userCredits').textContent = usuario.creditos || 0;
      document.getElementById('creditosBadge').innerHTML = 
        `💰 <span id="userCredits">${usuario.creditos || 0}</span> créditos`;
    }

    // Configurar controles de apuesta
    function configurarControlesApuesta() {
      const apuestaInput = document.getElementById('apuestaInput');
      const apuestaRange = document.getElementById('apuestaRange');
      
      // Sincronizar input y range
      apuestaInput.addEventListener('input', function() {
        let valor = parseInt(this.value);
        if (valor < 10) valor = 10;
        if (valor > 500) valor = 500;
        this.value = valor;
        apuestaRange.value = valor;
        actualizarCreditosDespues();
      });
      
      apuestaRange.addEventListener('input', function() {
        apuestaInput.value = this.value;
        actualizarCreditosDespues();
      });
    }

    // Actualizar créditos después de apuesta
    function actualizarCreditosDespues() {
      const apuesta = parseInt(document.getElementById('apuestaInput').value);
      const creditosDespues = (usuario.creditos || 0) - apuesta;
      document.getElementById('creditosDespues').textContent = creditosDespues;
      
      // Cambiar color si no hay suficientes créditos
      if (creditosDespues < 0) {
        document.getElementById('creditosDespues').style.color = '#dc3545';
        document.getElementById('btnJugar').disabled = true;
      } else {
        document.getElementById('creditosDespues').style.color = '#ffc107';
        document.getElementById('btnJugar').disabled = false;
      }
    }

    // Apuesta rápida
    function apuestaRapida(cantidad) {
      document.getElementById('apuestaInput').value = cantidad;
      document.getElementById('apuestaRange').value = cantidad;
      actualizarCreditosDespues();
    }

    // Función principal para jugar
    async function jugarDados() {
      if (juegoActivo) return;
      
      const apuesta = parseInt(document.getElementById('apuestaInput').value);
      
      // Validaciones
      if (apuesta < 10 || apuesta > 500) {
        mostrarError('La apuesta debe estar entre 10 y 500 créditos');
        return;
      }

      if (!usuario || usuario.creditos < apuesta) {
        mostrarError('No tienes suficientes créditos para esta apuesta');
        return;
      }

      juegoActivo = true;
      document.getElementById('btnJugar').disabled = true;
      document.getElementById('btnJugar').innerHTML = '🎲 LANZANDO DADOS...';

      // Animación de dados girando
      iniciarAnimacionDados();

      try {
        // Simular juego de dados (en un sistema real, esto sería en el backend)
        setTimeout(() => {
          procesarResultado(apuesta);
          juegoActivo = false;
          document.getElementById('btnJugar').disabled = false;
          document.getElementById('btnJugar').innerHTML = '🎲 JUGAR DADOS';
        }, 2000);

      } catch (error) {
        console.error('Error jugando:', error);
        mostrarError('Error de conexión');
        juegoActivo = false;
        document.getElementById('btnJugar').disabled = false;
        document.getElementById('btnJugar').innerHTML = '🎲 JUGAR DADOS';
      }
    }

    // Animación de dados girando
    function iniciarAnimacionDados() {
      const dados = [
        'usuarioDado1', 'usuarioDado2', 
        'computadoraDado1', 'computadoraDado2'
      ];

      dados.forEach(dadoId => {
        const dado = document.getElementById(dadoId);
        dado.textContent = '?';
        dado.classList.add('rolling');
      });

      document.getElementById('usuarioTotal').textContent = '?';
      document.getElementById('computadoraTotal').textContent = '?';
      document.getElementById('resultadoDiv').style.display = 'none';
      document.getElementById('accionesDiv').style.display = 'none';
    }

    // Procesar resultado del juego
    function procesarResultado(apuesta) {
      // Generar números aleatorios para los dados
      const usuarioDado1 = Math.floor(Math.random() * 6) + 1;
      const usuarioDado2 = Math.floor(Math.random() * 6) + 1;
      const computadoraDado1 = Math.floor(Math.random() * 6) + 1;
      const computadoraDado2 = Math.floor(Math.random() * 6) + 1;
      
      const usuarioTotal = usuarioDado1 + usuarioDado2;
      const computadoraTotal = computadoraDado1 + computadoraDado2;

      // Detener animación
      const dados = [
        'usuarioDado1', 'usuarioDado2', 
        'computadoraDado1', 'computadoraDado2'
      ];
      dados.forEach(dadoId => {
        document.getElementById(dadoId).classList.remove('rolling');
      });

      // Mostrar valores reales
      document.getElementById('usuarioDado1').textContent = usuarioDado1;
      document.getElementById('usuarioDado2').textContent = usuarioDado2;
      document.getElementById('computadoraDado1').textContent = computadoraDado1;
      document.getElementById('computadoraDado2').textContent = computadoraDado2;
      
      document.getElementById('usuarioTotal').textContent = usuarioTotal;
      document.getElementById('computadoraTotal').textContent = computadoraTotal;

      // Determinar resultado
      let resultado = '';
      let mensaje = '';
      let clase = '';
      let creditosGanados = 0;
      let creditosPerdidos = 0;

      if (usuarioDado1 === 6 && usuarioDado2 === 6) {
        // Doble 6 - gana el doble
        resultado = 'DOBLE 6';
        mensaje = '🎯 ¡DOBLE 6! ¡GANASTE EL DOBLE!';
        clase = 'ganador';
        creditosGanados = apuesta * 2;
        usuario.creditos += creditosGanados;
      } else if (computadoraDado1 === 6 && computadoraDado2 === 6) {
        // Computadora saca doble 6
        resultado = 'PERDEDOR';
        mensaje = '❌ ¡La computadora sacó DOBLE 6!';
        clase = 'perdedor';
        creditosPerdidos = apuesta;
        usuario.creditos -= creditosPerdidos;
      } else if (usuarioTotal > computadoraTotal) {
        // Usuario gana
        resultado = 'GANADOR';
        mensaje = '🎉 ¡GANASTE!';
        clase = 'ganador';
        creditosGanados = apuesta;
        usuario.creditos += creditosGanados;
      } else if (usuarioTotal < computadoraTotal) {
        // Computadora gana
        resultado = 'PERDEDOR';
        mensaje = '❌ ¡PERDISTE!';
        clase = 'perdedor';
        creditosPerdidos = apuesta;
        usuario.creditos -= creditosPerdidos;
      } else {
        // Empate
        resultado = 'EMPATE';
        mensaje = '⚖️ ¡EMPATE!';
        clase = 'empate';
        // En empate, no se gana ni pierde créditos
      }

      // Mostrar resultado
      const resultadoDiv = document.getElementById('resultadoDiv');
      const resultadoTexto = document.getElementById('resultadoTexto');
      const resultadoDetalle = document.getElementById('resultadoDetalle');
      const accionesDiv = document.getElementById('accionesDiv');

      resultadoDiv.style.display = 'block';
      accionesDiv.style.display = 'block';

      resultadoTexto.textContent = mensaje;
      resultadoDiv.className = `resultado ${clase}`;
      
      let detalleHtml = '';
      if (creditosGanados > 0) {
        detalleHtml = `<div class="mt-2">+${creditosGanados} créditos</div>`;
      } else if (creditosPerdidos > 0) {
        detalleHtml = `<div class="mt-2">-${creditosPerdidos} créditos</div>`;
      }
      resultadoDetalle.innerHTML = detalleHtml;

      // Actualizar localStorage y mostrar
      localStorage.setItem('user', JSON.stringify(usuario));
      mostrarInfoUsuario();
      actualizarCreditosDespues();

      // Guardar en historial
      guardarEnHistorial({
        fecha: new Date().toISOString(),
        apuesta: apuesta,
        resultado: resultado,
        usuarioDados: [usuarioDado1, usuarioDado2],
        computadoraDados: [computadoraDado1, computadoraDado2],
        usuarioTotal: usuarioTotal,
        computadoraTotal: computadoraTotal,
        creditosGanados: creditosGanados,
        creditosPerdidos: creditosPerdidos,
        creditosFinales: usuario.creditos
      });

      // Mostrar historial
      mostrarHistorial();
    }

    // Guardar partida en historial
    function guardarEnHistorial(partida) {
      historialJuegos.unshift(partida);
      // Mantener solo las últimas 10 partidas
      if (historialJuegos.length > 10) {
        historialJuegos = historialJuegos.slice(0, 10);
      }
    }

    // Mostrar historial de partidas
    function mostrarHistorial() {
      const historialLista = document.getElementById('historialLista');
      const historialContainer = document.getElementById('historialContainer');
      
      if (historialJuegos.length === 0) {
        historialContainer.style.display = 'none';
        return;
      }
      
      historialContainer.style.display = 'block';
      
      let html = '';
      historialJuegos.forEach((partida, index) => {
        const fecha = new Date(partida.fecha).toLocaleTimeString();
        const clase = partida.resultado === 'GANADOR' ? 'historial-ganador' : 
                     partida.resultado === 'PERDEDOR' ? 'historial-perdedor' : 
                     'historial-empate';
        
        html += `
          <div class="historial-item ${clase}">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>${partida.resultado}</strong>
                <div class="small text-muted">${fecha}</div>
              </div>
              <div class="text-end">
                <div>Apuesta: ${partida.apuesta} créditos</div>
                <div>
                  ${partida.creditosGanados > 0 ? 
                    `<span class="text-success">+${partida.creditosGanados}💰</span>` : 
                    partida.creditosPerdidos > 0 ? 
                    `<span class="text-danger">-${partida.creditosPerdidos}💰</span>` : 
                    '<span class="text-warning">0💰</span>'}
                </div>
              </div>
            </div>
            <div class="small mt-2">
              Tú: ${partida.usuarioDados[0]}+${partida.usuarioDados[1]}=${partida.usuarioTotal} 
              | PC: ${partida.computadoraDados[0]}+${partida.computadoraDados[1]}=${partida.computadoraTotal}
            </div>
          </div>
        `;
      });
      
      historialLista.innerHTML = html;
    }

    // Mostrar error
    function mostrarError(mensaje) {
      const resultadoDiv = document.getElementById('resultadoDiv');
      const resultadoTexto = document.getElementById('resultadoTexto');
      
      resultadoDiv.style.display = 'block';
      resultadoDiv.className = 'resultado perdedor';
      resultadoTexto.textContent = mensaje;
      
      setTimeout(() => {
        resultadoDiv.style.display = 'none';
      }, 3000);
    }

    // Reiniciar juego
    function resetJuego() {
      document.getElementById('usuarioDado1').textContent = '?';
      document.getElementById('usuarioDado2').textContent = '?';
      document.getElementById('computadoraDado1').textContent = '?';
      document.getElementById('computadoraDado2').textContent = '?';
      document.getElementById('usuarioTotal').textContent = '0';
      document.getElementById('computadoraTotal').textContent = '0';
      document.getElementById('resultadoDiv').style.display = 'none';
      document.getElementById('accionesDiv').style.display = 'none';
      document.getElementById('historialContainer').style.display = 'none';
      document.getElementById('apuestaInput').value = '50';
      document.getElementById('apuestaRange').value = '50';
      actualizarCreditosDespues();
    }

    // Cargar historial del localStorage al iniciar
    function cargarHistorial() {
      const historialGuardado = localStorage.getItem('historialDados');
      if (historialGuardado) {
        historialJuegos = JSON.parse(historialGuardado);
        mostrarHistorial();
      }
    }

    // Guardar historial en localStorage
    function guardarHistorial() {
      localStorage.setItem('historialDados', JSON.stringify(historialJuegos));
    }

    // Cargar historial al inicio
    cargarHistorial();
  </script>
</body>
</html>