<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recargar Puntos - Rifa 33</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .recargas-container {
            padding: 20px;
        }
        
        .recarga-steps {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            position: relative;
        }
        
        .recarga-steps::before {
            content: '';
            position: absolute;
            top: 25px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: #e0e0e0;
            z-index: 1;
        }
        
        .step {
            text-align: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }
        
        .step-number {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            font-size: 20px;
            transition: all 0.3s ease;
        }
        
        .step.active .step-number {
            background: #4caf50;
            color: white;
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
        }
        
        .step-label {
            font-weight: 500;
            color: #666;
        }
        
        .step.active .step-label {
            color: #4caf50;
            font-weight: 600;
        }
        
        .recarga-form-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .form-title {
            margin-bottom: 25px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .amount-selection {
            margin: 25px 0;
        }
        
        .amount-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .amount-btn {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .amount-btn:hover {
            border-color: #4caf50;
            background: #f1f8e9;
        }
        
        .amount-btn.selected {
            border-color: #4caf50;
            background: #e8f5e9;
            font-weight: bold;
            color: #2e7d32;
        }
        
        .amount-btn .amount {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .amount-btn .points {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .custom-amount {
            margin-top: 20px;
        }
        
        .custom-amount-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .custom-amount-input span {
            font-weight: 500;
        }
        
        .custom-amount-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .payment-methods {
            margin: 30px 0;
        }
        
        .method-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .method-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .method-card:hover {
            border-color: #2196f3;
            background: #f0f8ff;
        }
        
        .method-card.selected {
            border-color: #2196f3;
            background: #e3f2fd;
        }
        
        .method-icon {
            font-size: 40px;
            margin-bottom: 15px;
            color: #2196f3;
        }
        
        .method-name {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }
        
        .method-description {
            color: #666;
            font-size: 14px;
        }
        
        .payment-details {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 20px;
            margin: 25px 0;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .detail-row.total {
            border-bottom: none;
            font-weight: bold;
            font-size: 18px;
            color: #2196f3;
        }
        
        .bank-info {
            background: #e8f5e9;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #4caf50;
        }
        
        .bank-details {
            margin-top: 15px;
        }
        
        .bank-field {
            display: flex;
            margin: 8px 0;
        }
        
        .bank-label {
            font-weight: 600;
            width: 150px;
            color: #2e7d32;
        }
        
        .bank-value {
            flex: 1;
            font-family: monospace;
            background: white;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #c8e6c9;
        }
        
        .upload-receipt {
            margin: 25px 0;
        }
        
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }
        
        .upload-area:hover {
            border-color: #2196f3;
            background: #f0f8ff;
        }
        
        .upload-area.dragover {
            border-color: #4caf50;
            background: #e8f5e9;
        }
        
        .upload-icon {
            font-size: 50px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .upload-text {
            color: #666;
            margin-bottom: 10px;
        }
        
        .upload-note {
            font-size: 12px;
            color: #999;
        }
        
        .recarga-history {
            margin-top: 40px;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .history-table th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #ddd;
        }
        
        .history-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background: #d4edda;
            color: #155724;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .action-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .action-btn.primary {
            background: #4caf50;
            color: white;
        }
        
        .action-btn.primary:hover {
            background: #388e3c;
        }
        
        .action-btn.secondary {
            background: #f5f5f5;
            color: #666;
        }
        
        .action-btn.secondary:hover {
            background: #e0e0e0;
        }
        
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="user-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="user-info" id="sidebarUserInfo">
                    <h3>Cargando...</h3>
                    <p class="user-role">Usuario</p>
                </div>
                <div class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </div>
            </div>
            
            <nav class="sidebar-menu">
                <a href="dashboard.html" class="menu-item">
                    <i class="fas fa-home"></i>
                    <span>Inicio</span>
                </a>
                <a href="tickets.html" class="menu-item">
                    <i class="fas fa-ticket-alt"></i>
                    <span>Comprar Tickets</span>
                </a>
                <a href="recargas.html" class="menu-item active">
                    <i class="fas fa-coins"></i>
                    <span>Recargar Puntos</span>
                </a>
                <a href="transferencias.html" class="menu-item">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Transferencias</span>
                </a>
                <a href="historial.html" class="menu-item">
                    <i class="fas fa-history"></i>
                    <span>Historial</span>
                </a>
                <a href="perfil.html" class="menu-item">
                    <i class="fas fa-user-cog"></i>
                    <span>Mi Perfil</span>
                </a>
                
                <div class="menu-divider"></div>
                
                <a href="admin.html" class="menu-item admin-item" id="adminLink">
                    <i class="fas fa-crown"></i>
                    <span>Panel Admin</span>
                </a>
                
                <a href="#" class="menu-item logout-item" onclick="cerrarSesion()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Cerrar Sesi√≥n</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="points-display" id="sidebarPoints">
                    <i class="fas fa-coins"></i>
                    <div>
                        <span class="points-label">Tus Puntos</span>
                        <span class="points-value">0</span>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <div class="top-bar-left">
                    <h1>üí∞ Recargar Puntos</h1>
                    <p class="welcome-text">Convierte dinero en puntos para comprar tickets</p>
                </div>
                <div class="top-bar-right">
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-trigger">
                            <span id="userName">Cargando...</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="dropdown-menu">
                            <a href="perfil.html"><i class="fas fa-user"></i> Mi Perfil</a>
                            <a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
                            <div class="dropdown-divider"></div>
                            <a href="#" onclick="cerrarSesion()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="recargas-container">
                <!-- Pasos del proceso -->
                <div class="recarga-steps">
                    <div class="step active" id="step1">
                        <div class="step-number">1</div>
                        <div class="step-label">Seleccionar Monto</div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-number">2</div>
                        <div class="step-label">M√©todo de Pago</div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-number">3</div>
                        <div class="step-label">Subir Comprobante</div>
                    </div>
                    <div class="step" id="step4">
                        <div class="step-number">4</div>
                        <div class="step-label">Confirmar</div>
                    </div>
                </div>
                
                <!-- Paso 1: Seleccionar Monto -->
                <div class="recarga-form-section" id="step1Section">
                    <h2 class="form-title">
                        <i class="fas fa-money-bill-wave"></i> ¬øCu√°ntos puntos deseas recargar?
                    </h2>
                    
                    <div class="info-card">
                        <p><i class="fas fa-info-circle"></i> Tasa de cambio actual: 
                           <strong id="exchangeRate">100 puntos = $1.00</strong></p>
                        <p>M√≠nimo de recarga: <strong>$5.00 (500 puntos)</strong></p>
                    </div>
                    
                    <div class="amount-selection">
                        <h3>Montos sugeridos:</h3>
                        <div class="amount-buttons" id="amountButtons">
                            <!-- Los botones de montos se generar√°n din√°micamente -->
                        </div>
                        
                        <div class="custom-amount">
                            <h3>O ingresa un monto personalizado:</h3>
                            <div class="custom-amount-input">
                                <span>$</span>
                                <input type="number" 
                                       id="customAmount" 
                                       min="5" 
                                       max="1000" 
                                       step="0.01"
                                       placeholder="Ej: 20.00">
                                <span>USD</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="payment-details">
                        <h3>üìã Resumen de la recarga:</h3>
                        <div class="detail-row">
                            <span>Monto a pagar:</span>
                            <span id="paymentAmount">$0.00</span>
                        </div>
                        <div class="detail-row">
                            <span>Tasa de cambio:</span>
                            <span id="rateDisplay">100 pts/$</span>
                        </div>
                        <div class="detail-row total">
                            <span>Puntos a recibir:</span>
                            <span id="pointsToReceive">0 puntos</span>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button class="action-btn secondary" onclick="goToDashboard()">
                            <i class="fas fa-arrow-left"></i> Cancelar
                        </button>
                        <button class="action-btn primary" onclick="nextStep(2)" id="nextStep1">
                            <i class="fas fa-arrow-right"></i> Continuar
                        </button>
                    </div>
                </div>
                
                <!-- Paso 2: M√©todo de Pago -->
                <div class="recarga-form-section" id="step2Section" style="display: none;">
                    <h2 class="form-title">
                        <i class="fas fa-credit-card"></i> Selecciona tu m√©todo de pago
                    </h2>
                    
                    <div class="payment-methods">
                        <div class="method-cards">
                            <div class="method-card" data-method="pago_movil" onclick="selectPaymentMethod('pago_movil')">
                                <div class="method-icon">
                                    <i class="fas fa-mobile-alt"></i>
                                </div>
                                <div class="method-name">Pago M√≥vil</div>
                                <div class="method-description">
                                    Transferencia r√°pida desde tu tel√©fono
                                </div>
                            </div>
                            
                            <div class="method-card" data-method="transferencia" onclick="selectPaymentMethod('transferencia')">
                                <div class="method-icon">
                                    <i class="fas fa-university"></i>
                                </div>
                                <div class="method-name">Transferencia Bancaria</div>
                                <div class="method-description">
                                    Desde cualquier banco nacional
                                </div>
                            </div>
                            
                            <div class="method-card" data-method="efectivo" onclick="selectPaymentMethod('efectivo')">
                                <div class="method-icon">
                                    <i class="fas fa-money-bill"></i>
                                </div>
                                <div class="method-name">Dep√≥sito en Efectivo</div>
                                <div class="method-description">
                                    En ventanilla bancaria
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Informaci√≥n bancaria (se muestra seg√∫n m√©todo) -->
                    <div class="bank-info" id="bankInfo" style="display: none;">
                        <h3><i class="fas fa-university"></i> Datos para la transferencia:</h3>
                        <div class="bank-details">
                            <div class="bank-field">
                                <span class="bank-label">Banco:</span>
                                <span class="bank-value">BANCO NACIONAL</span>
                            </div>
                            <div class="bank-field">
                                <span class="bank-label">Tipo de Cuenta:</span>
                                <span class="bank-value">Corriente</span>
                            </div>
                            <div class="bank-field">
                                <span class="bank-label">N√∫mero de Cuenta:</span>
                                <span class="bank-value">0192-1234-56-1234567890</span>
                            </div>
                            <div class="bank-field">
                                <span class="bank-label">Titular:</span>
                                <span class="bank-value">RIFA 33 C.A.</span>
                            </div>
                            <div class="bank-field">
                                <span class="bank-label">RIF/C√©dula:</span>
                                <span class="bank-value">J-12345678-9</span>
                            </div>
                            <div class="bank-field">
                                <span class="bank-label">Correo para confirmaci√≥n:</span>
                                <span class="bank-value">confirmaciones@rifa33.com</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Informaci√≥n Pago M√≥vil -->
                    <div class="bank-info" id="pagoMovilInfo" style="display: none;">
                        <h3><i class="fas fa-mobile-alt"></i> Datos para Pago M√≥vil:</h3>
                        <div class="bank-details">
                            <div class="bank-field">
                                <span class="bank-label">Banco:</span>
                                <span class="bank-value">BANCO NACIONAL</span>
                            </div>
                            <div class="bank-field">
                                <span class="bank-label">Tel√©fono:</span>
                                <span class="bank-value">0412-123-4567</span>
                            </div>
                            <div class="bank-field">
                                <span class="bank-label">C√©dula/RIF:</span>
                                <span class="bank-value">12345678</span>
                            </div>
                            <div class="bank-field">
                                <span class="bank-label">Nombre:</span>
                                <span class="bank-value">RIFA 33</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button class="action-btn secondary" onclick="prevStep(1)">
                            <i class="fas fa-arrow-left"></i> Regresar
                        </button>
                        <button class="action-btn primary" onclick="nextStep(3)" id="nextStep2" disabled>
                            <i class="fas fa-arrow-right"></i> Continuar
                        </button>
                    </div>
                </div>
                
                <!-- Paso 3: Subir Comprobante -->
                <div class="recarga-form-section" id="step3Section" style="display: none;">
                    <h2 class="form-title">
                        <i class="fas fa-file-upload"></i> Sube tu comprobante de pago
                    </h2>
                    
                    <div class="upload-receipt">
                        <p><i class="fas fa-info-circle"></i> Para agilizar la aprobaci√≥n, sube una imagen clara de tu comprobante de pago.</p>
                        
                        <div class="upload-area" id="uploadArea" onclick="document.getElementById('receiptFile').click()">
                            <div class="upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="upload-text">
                                Haz clic aqu√≠ o arrastra tu comprobante
                            </div>
                            <div class="upload-note">
                                Formatos aceptados: JPG, PNG, PDF (M√°x. 5MB)
                            </div>
                        </div>
                        
                        <input type="file" 
                               id="receiptFile" 
                               accept="image/*,.pdf" 
                               style="display: none;"
                               onchange="handleFileUpload(this)">
                        
                        <div class="preview-container" id="previewContainer" style="display: none; margin-top: 20px;">
                            <h4>Vista previa:</h4>
                            <div class="preview-content" id="previewContent"></div>
                            <button class="btn-small btn-danger" onclick="removeUpload()">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                        
                        <div class="reference-input" style="margin-top: 20px;">
                            <label for="referenceNumber">
                                <i class="fas fa-hashtag"></i> N√∫mero de referencia:
                            </label>
                            <input type="text" 
                                   id="referenceNumber" 
                                   placeholder="Ej: 123456789"
                                   class="form-control"
                                   style="width: 100%; padding: 10px; margin-top: 10px;">
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button class="action-btn secondary" onclick="prevStep(2)">
                            <i class="fas fa-arrow-left"></i> Regresar
                        </button>
                        <button class="action-btn primary" onclick="nextStep(4)" id="nextStep3" disabled>
                            <i class="fas fa-arrow-right"></i> Continuar
                        </button>
                    </div>
                </div>
                
                <!-- Paso 4: Confirmaci√≥n -->
                <div class="recarga-form-section" id="step4Section" style="display: none;">
                    <h2 class="form-title">
                        <i class="fas fa-check-circle"></i> Confirma los datos de tu recarga
                    </h2>
                    
                    <div class="confirmation-details">
                        <div class="detail-card">
                            <h4><i class="fas fa-money-bill-wave"></i> Monto</h4>
                            <div class="confirmation-value" id="confirmAmount">$0.00</div>
                            <div class="confirmation-subtext" id="confirmPoints">0 puntos</div>
                        </div>
                        
                        <div class="detail-card">
                            <h4><i class="fas fa-credit-card"></i> M√©todo de Pago</h4>
                            <div class="confirmation-value" id="confirmMethod">No seleccionado</div>
                        </div>
                        
                        <div class="detail-card">
                            <h4><i class="fas fa-hashtag"></i> Referencia</h4>
                            <div class="confirmation-value" id="confirmReference">Sin referencia</div>
                        </div>
                        
                        <div class="detail-card">
                            <h4><i class="fas fa-file"></i> Comprobante</h4>
                            <div class="confirmation-value" id="confirmReceipt">No subido</div>
                        </div>
                    </div>
                    
                    <div class="terms-checkbox" style="margin: 30px 0;">
                        <label class="checkbox">
                            <input type="checkbox" id="confirmTerms">
                            <span>Confirmo que he realizado el pago seg√∫n los datos proporcionados y que toda la informaci√≥n es correcta.</span>
                        </label>
                    </div>
                    
                    <div class="final-info">
                        <p><i class="fas fa-clock"></i> <strong>Tiempo de procesamiento:</strong> 1-24 horas h√°biles</p>
                        <p><i class="fas fa-envelope"></i> Recibir√°s una notificaci√≥n por correo cuando tu recarga sea aprobada.</p>
                    </div>
                    
                    <div class="form-actions">
                        <button class="action-btn secondary" onclick="prevStep(3)">
                            <i class="fas fa-arrow-left"></i> Regresar
                        </button>
                        <button class="action-btn primary" onclick="submitRecharge()" id="submitRecharge" disabled>
                            <i class="fas fa-paper-plane"></i> Enviar Solicitud
                        </button>
                    </div>
                </div>
                
                <!-- Historial de recargas -->
                <div class="recarga-history">
                    <h2><i class="fas fa-history"></i> Historial de Recargas</h2>
                    
                    <div class="table-responsive">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Monto</th>
                                    <th>Puntos</th>
                                    <th>M√©todo</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="rechargeHistory">
                                <!-- El historial se cargar√° din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="empty-state" id="emptyHistory" style="display: none;">
                        <i class="fas fa-coins" style="font-size: 50px; color: #ccc;"></i>
                        <p>No has realizado ninguna recarga a√∫n</p>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal de √©xito -->
    <div class="modal" id="successModal">
        <div class="modal-content">
            <div class="modal-icon success">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3>¬°Solicitud Enviada!</h3>
            <p id="successMessage">Tu solicitud de recarga ha sido enviada exitosamente.</p>
            <div class="modal-details" id="modalDetails"></div>
            <div class="modal-actions">
                <button class="btn-primary" onclick="closeSuccessModal()">
                    <i class="fas fa-check"></i> Entendido
                </button>
                <button class="btn-secondary" onclick="goToDashboard()">
                    <i class="fas fa-home"></i> Ir al Dashboard
                </button>
            </div>
        </div>
    </div>
    
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/recargas.js"></script>
    <script>
        // Variables globales para recargas
        let recargaData = {
            monto: 0,
            puntos: 0,
            metodo: null,
            referencia: '',
            comprobante: null,
            fileName: ''
        };
        
        let exchangeRate = 100; // Puntos por d√≥lar
        
        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', async () => {
            const usuario = window.verificarAutenticacion();
            if (!usuario) return;
            
            await initRecargas();
            setupUserDropdown();
            setupFileUpload();
            
            // Actualizar informaci√≥n del usuario
            document.getElementById('sidebarUserInfo').innerHTML = `
                <h3>${usuario.nombre}</h3>
                <p class="user-role">${usuario.role === 'admin' ? 'Administrador' : 'Usuario'}</p>
            `;
            document.getElementById('userName').textContent = usuario.nombre;
            document.getElementById('sidebarPoints').innerHTML = `
                <i class="fas fa-coins"></i>
                <div>
                    <span class="points-label">Tus Puntos</span>
                    <span class="points-value">${usuario.puntos}</span>
                </div>
            `;
        });
        
        async function initRecargas() {
            try {
                // Cargar tasa de cambio
                const config = await window.obtenerUno("SELECT puntos_por_dolar FROM system_config WHERE id = 1");
                if (config) {
                    exchangeRate = config.puntos_por_dolar;
                    document.getElementById('exchangeRate').textContent = 
                        `${exchangeRate} puntos = $1.00`;
                    document.getElementById('rateDisplay').textContent = 
                        `${exchangeRate} pts/$`;
                }
                
                // Generar botones de montos sugeridos
                generateAmountButtons();
                
                // Cargar historial
                await loadRechargeHistory();
                
            } catch (error) {
                console.error('Error al inicializar recargas:', error);
            }
        }
        
        function generateAmountButtons() {
            const amounts = [
                { monto: 5, label: "$5.00", popular: false },
                { monto: 10, label: "$10.00", popular: true },
                { monto: 20, label: "$20.00", popular: false },
                { monto: 50, label: "$50.00", popular: true },
                { monto: 100, label: "$100.00", popular: false }
            ];
            
            const container = document.getElementById('amountButtons');
            container.innerHTML = '';
            
            amounts.forEach(amount => {
                const puntos = amount.monto * exchangeRate;
                const button = document.createElement('button');
                button.className = 'amount-btn';
                button.innerHTML = `
                    <div class="amount">${amount.label}</div>
                    <div class="points">${puntos.toLocaleString()} puntos</div>
                `;
                
                button.addEventListener('click', () => {
                    // Remover selecci√≥n de otros botones
                    document.querySelectorAll('.amount-btn').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    
                    // Seleccionar este bot√≥n
                    button.classList.add('selected');
                    
                    // Actualizar monto personalizado
                    document.getElementById('customAmount').value = amount.monto;
                    
                    // Actualizar datos
                    updateRecargaData(amount.monto);
                });
                
                container.appendChild(button);
            });
        }
        
        function updateRecargaData(monto) {
            recargaData.monto = parseFloat(monto);
            recargaData.puntos = Math.floor(monto * exchangeRate);
            
            // Actualizar UI
            document.getElementById('paymentAmount').textContent = `$${monto.toFixed(2)}`;
            document.getElementById('pointsToReceive').textContent = 
                `${recargaData.puntos.toLocaleString()} puntos`;
            
            // Actualizar paso 4
            document.getElementById('confirmAmount').textContent = `$${monto.toFixed(2)}`;
            document.getElementById('confirmPoints').textContent = 
                `${recargaData.puntos.toLocaleString()} puntos`;
            
            // Habilitar siguiente paso si hay monto v√°lido
            const nextBtn1 = document.getElementById('nextStep1');
            if (monto >= 5) {
                nextBtn1.disabled = false;
            } else {
                nextBtn1.disabled = true;
            }
        }
        
        // Escuchar cambios en monto personalizado
        document.getElementById('customAmount').addEventListener('input', function() {
            const monto = parseFloat(this.value) || 0;
            
            // Remover selecci√≥n de botones
            document.querySelectorAll('.amount-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            updateRecargaData(monto);
        });
        
        // Navegaci√≥n entre pasos
        function nextStep(step) {
            // Validar paso actual antes de continuar
            if (step === 2 && recargaData.monto < 5) {
                alert('El monto m√≠nimo es $5.00');
                return;
            }
            
            if (step === 3 && !recargaData.metodo) {
                alert('Selecciona un m√©todo de pago');
                return;
            }
            
            // Ocultar todos los pasos
            document.querySelectorAll('.recarga-form-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Mostrar paso actual
            document.getElementById(`step${step}Section`).style.display = 'block';
            
            // Actualizar indicador de pasos
            document.querySelectorAll('.step').forEach(s => {
                s.classList.remove('active');
            });
            document.getElementById(`step${step}`).classList.add('active');
        }
        
        function prevStep(step) {
            nextStep(step);
        }
        
        function selectPaymentMethod(method) {
            recargaData.metodo = method;
            
            // Remover selecci√≥n de otros m√©todos
            document.querySelectorAll('.method-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Seleccionar m√©todo actual
            event.target.closest('.method-card').classList.add('selected');
            
            // Mostrar informaci√≥n seg√∫n m√©todo
            document.getElementById('bankInfo').style.display = 'none';
            document.getElementById('pagoMovilInfo').style.display = 'none';
            
            if (method === 'transferencia' || method === 'efectivo') {
                document.getElementById('bankInfo').style.display = 'block';
            } else if (method === 'pago_movil') {
                document.getElementById('pagoMovilInfo').style.display = 'block';
            }
            
            // Actualizar paso 4
            let methodName = '';
            switch(method) {
                case 'pago_movil': methodName = 'Pago M√≥vil'; break;
                case 'transferencia': methodName = 'Transferencia Bancaria'; break;
                case 'efectivo': methodName = 'Dep√≥sito en Efectivo'; break;
            }
            document.getElementById('confirmMethod').textContent = methodName;
            
            // Habilitar siguiente paso
            document.getElementById('nextStep2').disabled = false;
        }
        
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('receiptFile');
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileUpload(fileInput);
                }
            });
            
            // Escuchar referencia
            document.getElementById('referenceNumber').addEventListener('input', function() {
                recargaData.referencia = this.value;
                document.getElementById('confirmReference').textContent = this.value || 'Sin referencia';
                checkStep3Completion();
            });
        }
        
        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            // Validar tama√±o (5MB m√°ximo)
            if (file.size > 5 * 1024 * 1024) {
                alert('El archivo es muy grande. M√°ximo 5MB.');
                return;
            }
            
            // Validar tipo
            const validTypes = ['image/jpeg', 'image/png', 'image/jpg', 'application/pdf'];
            if (!validTypes.includes(file.type)) {
                alert('Formato no v√°lido. Usa JPG, PNG o PDF.');
                return;
            }
            
            // Guardar datos
            recargaData.comprobante = file;
            recargaData.fileName = file.name;
            
            // Mostrar vista previa
            const previewContainer = document.getElementById('previewContainer');
            const previewContent = document.getElementById('previewContent');
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewContent.innerHTML = `
                        <img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 5px;">
                        <p>${file.name} (${(file.size / 1024).toFixed(1)} KB)</p>
                    `;
                };
                reader.readAsDataURL(file);
            } else {
                previewContent.innerHTML = `
                    <div class="file-icon">
                        <i class="fas fa-file-pdf" style="font-size: 50px; color: #f44336;"></i>
                    </div>
                    <p>${file.name} (${(file.size / 1024).toFixed(1)} KB)</p>
                `;
            }
            
            previewContainer.style.display = 'block';
            document.getElementById('confirmReceipt').textContent = file.name;
            
            checkStep3Completion();
        }
        
        function removeUpload() {
            recargaData.comprobante = null;
            recargaData.fileName = '';
            
            document.getElementById('receiptFile').value = '';
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('confirmReceipt').textContent = 'No subido';
            
            checkStep3Completion();
        }
        
        function checkStep3Completion() {
            const hasReference = recargaData.referencia.trim().length > 0;
            const hasFile = recargaData.comprobante !== null;
            
            // En un sistema real, podr√≠as requerir ambos o solo uno
            const isComplete = hasReference || hasFile;
            
            document.getElementById('nextStep3').disabled = !isComplete;
        }
        
        // Escuchar confirmaci√≥n de t√©rminos
        document.getElementById('confirmTerms').addEventListener('change', function() {
            document.getElementById('submitRecharge').disabled = !this.checked;
        });
        
        async function submitRecharge() {
            const usuario = JSON.parse(localStorage.getItem('usuarioRifa'));
            
            try {
                // Mostrar carga
                const submitBtn = document.getElementById('submitRecharge');
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
                submitBtn.disabled = true;
                
                // En un sistema real, aqu√≠ subir√≠as el archivo al servidor
                // Por ahora simularemos la subida
                let comprobanteUrl = '';
                if (recargaData.comprobante) {
                    // Simular upload
                    comprobanteUrl = `uploads/${Date.now()}_${recargaData.fileName}`;
                }
                
                // Insertar en base de datos
                const resultado = await window.ejecutarComando(`
                    INSERT INTO recargas (
                        user_id, monto, puntos_solicitados, 
                        metodo, comprobante_url, referencia,
                        estado
                    ) VALUES (
                        ${usuario.id},
                        ${recargaData.monto},
                        ${recargaData.puntos},
                        '${recargaData.metodo}',
                        '${comprobanteUrl}',
                        '${recargaData.referencia}',
                        'pendiente'
                    )
                `);
                
                if (resultado.success) {
                    // Mostrar modal de √©xito
                    document.getElementById('successMessage').textContent = 
                        `Tu solicitud de recarga por $${recargaData.monto.toFixed(2)} ha sido enviada.`;
                    
                    document.getElementById('modalDetails').innerHTML = `
                        <p><strong>N√∫mero de solicitud:</strong> #${resultado.meta?.last_row_id || 'N/A'}</p>
                        <p><strong>Puntos a recibir:</strong> ${recargaData.puntos.toLocaleString()}</p>
                        <p><strong>Estado:</strong> <span class="status-pending">Pendiente de aprobaci√≥n</span></p>
                        <p><i class="fas fa-info-circle"></i> Te notificaremos cuando sea aprobada.</p>
                    `;
                    
                    document.getElementById('successModal').style.display = 'flex';
                    
                    // Limpiar formulario
                    resetForm();
                    
                    // Actualizar historial
                    await loadRechargeHistory();
                    
                } else {
                    throw new Error('Error al guardar recarga');
                }
                
            } catch (error) {
                console.error('Error al enviar recarga:', error);
                alert('Error al enviar la solicitud. Intenta nuevamente.');
                
                // Restaurar bot√≥n
                const submitBtn = document.getElementById('submitRecharge');
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Solicitud';
                submitBtn.disabled = false;
            }
        }
        
        function resetForm() {
            // Resetear datos
            recargaData = {
                monto: 0,
                puntos: 0,
                metodo: null,
                referencia: '',
                comprobante: null,
                fileName: ''
            };
            
            // Resetear UI
            document.querySelectorAll('.amount-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelectorAll('.method-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('customAmount').value = '';
            document.getElementById('referenceNumber').value = '';
            document.getElementById('confirmTerms').checked = false;
            removeUpload();
            
            // Volver al paso 1
            nextStep(1);
        }
        
        async function loadRechargeHistory() {
            try {
                const usuario = JSON.parse(localStorage.getItem('usuarioRifa'));
                const historial = await window.obtenerDatos(`
                    SELECT id, monto, puntos_solicitados, metodo, estado, 
                           fecha_solicitud, fecha_resolucion, mensaje_admin
                    FROM recargas 
                    WHERE user_id = ${usuario.id}
                    ORDER BY fecha_solicitud DESC
                    LIMIT 10
                `);
                
                const tbody = document.getElementById('rechargeHistory');
                const emptyState = document.getElementById('emptyHistory');
                
                if (historial.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.style.display = 'block';
                    return;
                }
                
                emptyState.style.display = 'none';
                
                let html = '';
                historial.forEach(item => {
                    const fecha = new Date(item.fecha_solicitud).toLocaleDateString();
                    let estadoClass = '';
                    let estadoText = '';
                    
                    switch(item.estado) {
                        case 'pendiente':
                            estadoClass = 'status-pending';
                            estadoText = 'Pendiente';
                            break;
                        case 'aprobado':
                            estadoClass = 'status-approved';
                            estadoText = 'Aprobado';
                            break;
                        case 'rechazado':
                            estadoClass = 'status-rejected';
                            estadoText = 'Rechazado';
                            break;
                    }
                    
                    html += `
                        <tr>
                            <td>${fecha}</td>
                            <td>$${item.monto.toFixed(2)}</td>
                            <td>${item.puntos_solicitados.toLocaleString()} pts</td>
                            <td>${item.metodo === 'pago_movil' ? 'Pago M√≥vil' : 
                                  item.metodo === 'transferencia' ? 'Transferencia' : 
                                  'Dep√≥sito'}</td>
                            <td><span class="status-badge ${estadoClass}">${estadoText}</span></td>
                            <td>
                                ${item.mensaje_admin ? 
                                  `<button class="btn-small" onclick="viewMessage('${item.mensaje_admin}')">
                                    <i class="fas fa-eye"></i> Ver mensaje
                                   </button>` : ''}
                            </td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html;
                
            } catch (error) {
                console.error('Error al cargar historial:', error);
            }
        }
        
        function viewMessage(message) {
            alert(`Mensaje del administrador:\n\n${message}`);
        }
        
        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
        }
        
        function goToDashboard() {
            window.location.href = 'dashboard.html';
        }
        
        function setupUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            const trigger = dropdown.querySelector('.dropdown-trigger');
            
            trigger.addEventListener('click', () => {
                dropdown.classList.toggle('active');
            });
            
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target)) {
                    dropdown.classList.remove('active');
                }
            });
        }
    </script>
</body>
</html>