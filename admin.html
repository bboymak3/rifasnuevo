<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Gran Rifa</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .btn-custom {
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .table-responsive {
      max-height: 500px;
      overflow-y: auto;
    }
    
    .modal-header {
      background: #dc3545;
      color: white;
    }
    
    .sticky-header {
      position: sticky;
      top: 0;
      background: white;
      z-index: 100;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-primary">
    <div class="container">
      <span class="navbar-brand">👨‍💼 Panel de Administración</span>
      <div>
        <a href="/index.html" class="btn btn-outline-light btn-sm">🏠 Inicio</a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <h2 class="text-center mb-4">Gestión de la Rifa</h2>
    
    <!-- Estadísticas -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h5>Total Tickets</h5>
            <h3 class="text-primary" id="totalTickets">100</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h5>Vendidos</h5>
            <h3 class="text-success" id="ticketsVendidos">0</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h5>Disponibles</h5>
            <h3 class="text-warning" id="ticketsDisponibles">100</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h5>Recaudado</h5>
            <h3 class="text-info" id="totalRecaudado">Bs. 0</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Botones de acción -->
    <div class="row mb-4">
      <div class="col-md-6">
        <button class="btn btn-success w-100 btn-custom" onclick="marcarComoPagado()">
          ✅ Marcar como Pagado
        </button>
      </div>
      <div class="col-md-6">
        <button class="btn btn-danger w-100 btn-custom" data-bs-toggle="modal" data-bs-target="#confirmModal">
          🗑️ Eliminar Todas las Órdenes
        </button>
      </div>
    </div>

    <!-- Información de órdenes -->
    <div class="alert alert-info sticky-header">
      <strong>📊 Total de órdenes: <span id="totalOrders">0</span></strong> | 
      <strong>✅ Pagadas: <span id="paidOrders">0</span></strong> | 
      <strong>⏳ Pendientes: <span id="pendingOrders">0</span></strong>
    </div>

    <!-- Tabla de órdenes -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">📋 Órdenes de Compra</h5>
        <div>
          <button class="btn btn-outline-success btn-sm me-2" onclick="agregarOrdenEjemplo()">
            ➕ Agregar Ejemplo
          </button>
          <button class="btn btn-outline-primary btn-sm" onclick="exportarDatos()">
            📤 Exportar Datos
          </button>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0">
            <thead class="table-dark">
              <tr>
                <th><input type="checkbox" id="selectAll"></th>
                <th>ID</th>
                <th>Teléfono</th>
                <th>Tickets</th>
                <th>Monto</th>
                <th>Estado</th>
                <th>Fecha</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="ordersTable">
              <!-- Las órdenes se cargarán aquí dinámicamente -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmación para Eliminar Tablas -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">⚠️ Confirmar Eliminación Total</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="alert alert-danger">
            <strong>¡ELIMINACIÓN COMPLETA!</strong><br>
            Esta acción <strong>ELIMINARÁ TODAS LAS ÓRDENES</strong> de la base de datos:
          </p>
          <ul>
            <li><strong id="ordersCount">0</strong> órdenes en total</li>
            <li><strong id="paidCount">0</strong> órdenes pagadas</li>
            <li><strong id="pendingCount">0</strong> órdenes pendientes</li>
          </ul>
          <p class="text-danger"><strong>Esta acción NO se puede deshacer.</strong></p>
          <div class="mb-3">
            <label for="confirmText" class="form-label">
              Escribe <strong>"ELIMINAR TODAS LAS ÓRDENES"</strong> para confirmar:
            </label>
            <input type="text" class="form-control" id="confirmText" placeholder="Escribe ELIMINAR TODAS LAS ÓRDENES aquí">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">❌ Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="eliminarTodasLasOrdenes()" disabled>
            🗑️ Eliminar Todas las Órdenes
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Datos de ejemplo más realistas
    let orders = [
      { id: 1, phone: '0412-1234567', tickets: [5, 12, 23], amount: 1497, status: 'Pendiente', date: '2024-01-15' },
      { id: 2, phone: '0414-7654321', tickets: [34, 45], amount: 998, status: 'Pagado', date: '2024-01-14' },
      { id: 3, phone: '0426-5558888', tickets: [56], amount: 499, status: 'Pendiente', date: '2024-01-15' },
      { id: 4, phone: '0412-9998888', tickets: [67, 78, 89], amount: 1497, status: 'Pagado', date: '2024-01-13' },
      { id: 5, phone: '0424-1112233', tickets: [11, 22], amount: 998, status: 'Pendiente', date: '2024-01-16' },
      { id: 6, phone: '0416-4445566', tickets: [33, 44, 55, 66], amount: 1996, status: 'Pagado', date: '2024-01-12' }
    ];

    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
      cargarOrdenes();
      actualizarEstadisticas();
      actualizarModalInfo();
      
      // Validación del texto de confirmación
      document.getElementById('confirmText').addEventListener('input', function() {
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        confirmBtn.disabled = this.value !== 'ELIMINAR TODAS LAS ÓRDENES';
      });
      
      // Seleccionar todos los checkboxes
      document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('#ordersTable input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
        });
      });

      // Actualizar información del modal cuando se abre
      document.getElementById('confirmModal').addEventListener('show.bs.modal', function() {
        actualizarModalInfo();
      });
    });

    // Actualizar información en el modal
    function actualizarModalInfo() {
      const totalOrders = orders.length;
      const paidOrders = orders.filter(order => order.status === 'Pagado').length;
      const pendingOrders = totalOrders - paidOrders;

      document.getElementById('ordersCount').textContent = totalOrders;
      document.getElementById('paidCount').textContent = paidOrders;
      document.getElementById('pendingCount').textContent = pendingOrders;
    }

    // Cargar órdenes en la tabla
    function cargarOrdenes() {
      const tbody = document.getElementById('ordersTable');
      tbody.innerHTML = '';

      if (orders.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="8" class="text-center text-muted py-4">
            <h5>No hay órdenes registradas</h5>
            <p>Usa el botón "Agregar Ejemplo" para cargar datos de prueba</p>
          </td>
        `;
        tbody.appendChild(row);
        return;
      }

      orders.forEach(order => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="checkbox" class="order-checkbox" data-id="${order.id}"></td>
          <td><strong>#${order.id}</strong></td>
          <td>${order.phone}</td>
          <td>
            <span class="badge bg-info">${order.tickets.length} tickets</span><br>
            <small>${order.tickets.join(', ')}</small>
          </td>
          <td><strong>Bs. ${order.amount.toLocaleString()}</strong></td>
          <td>
            <span class="badge ${order.status === 'Pagado' ? 'bg-success' : 'bg-warning'}">
              ${order.status}
            </span>
          </td>
          <td>${order.date}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary mb-1" onclick="editarOrden(${order.id})">
              ✏️ Editar
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="eliminarOrden(${order.id})">
              🗑️ Eliminar
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });

      // Actualizar contadores de órdenes
      actualizarContadoresOrdenes();
    }

    // Actualizar contadores de órdenes
    function actualizarContadoresOrdenes() {
      const totalOrders = orders.length;
      const paidOrders = orders.filter(order => order.status === 'Pagado').length;
      const pendingOrders = totalOrders - paidOrders;

      document.getElementById('totalOrders').textContent = totalOrders;
      document.getElementById('paidOrders').textContent = paidOrders;
      document.getElementById('pendingOrders').textContent = pendingOrders;
    }

    // Actualizar estadísticas generales
    function actualizarEstadisticas() {
      const ticketsVendidos = orders
        .filter(order => order.status === 'Pagado')
        .reduce((total, order) => total + order.tickets.length, 0);
      
      const totalRecaudado = orders
        .filter(order => order.status === 'Pagado')
        .reduce((total, order) => total + order.amount, 0);

      document.getElementById('ticketsVendidos').textContent = ticketsVendidos;
      document.getElementById('ticketsDisponibles').textContent = 100 - ticketsVendidos;
      document.getElementById('totalRecaudado').textContent = 'Bs. ' + totalRecaudado.toLocaleString();
    }

    // Marcar órdenes como pagadas
    function marcarComoPagado() {
      const selectedOrders = document.querySelectorAll('#ordersTable input[type="checkbox"]:checked');
      
      if (selectedOrders.length === 0) {
        alert('❌ Por favor selecciona al menos una orden para marcar como pagada.');
        return;
      }

      let updatedCount = 0;
      selectedOrders.forEach(checkbox => {
        const orderId = parseInt(checkbox.dataset.id);
        const order = orders.find(o => o.id === orderId);
        if (order && order.status === 'Pendiente') {
          order.status = 'Pagado';
          updatedCount++;
        }
      });

      cargarOrdenes();
      actualizarEstadisticas();
      alert(`✅ ${updatedCount} órdenes marcadas como pagadas correctamente.`);
    }

    // ELIMINAR TODAS LAS ÓRDENES - FUNCIÓN PRINCIPAL CORREGIDA
    function eliminarTodasLasOrdenes() {
      if (orders.length === 0) {
        alert('ℹ️ No hay órdenes para eliminar.');
        return;
      }

      // Cerrar el modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
      modal.hide();
      
      // Mostrar mensaje de proceso
      alert(`🗑️ Eliminando ${orders.length} órdenes...`);
      
      // ELIMINAR TODAS LAS ÓRDENES
      orders = []; // Esto vacía completamente el array
      
      // Actualizar la interfaz
      cargarOrdenes();
      actualizarEstadisticas();
      actualizarContadoresOrdenes();
      
      // Limpiar el campo de confirmación
      document.getElementById('confirmText').value = '';
      document.getElementById('confirmDeleteBtn').disabled = true;
      
      // Mostrar confirmación final
      setTimeout(() => {
        alert('✅ ¡Todas las órdenes han sido eliminadas correctamente!');
      }, 500);
    }

    // Funciones auxiliares
    function agregarOrdenEjemplo() {
      const newId = orders.length > 0 ? Math.max(...orders.map(o => o.id)) + 1 : 1;
      const newOrder = {
        id: newId,
        phone: '0412-' + Math.floor(1000000 + Math.random() * 9000000),
        tickets: [Math.floor(Math.random() * 100) + 1],
        amount: 499,
        status: 'Pendiente',
        date: new Date().toISOString().split('T')[0]
      };
      
      orders.push(newOrder);
      cargarOrdenes();
      actualizarEstadisticas();
      alert(`✅ Nueva orden de ejemplo #${newId} agregada.`);
    }

    function editarOrden(id) {
      const order = orders.find(o => o.id === id);
      if (order) {
        const newStatus = order.status === 'Pagado' ? 'Pendiente' : 'Pagado';
        order.status = newStatus;
        cargarOrdenes();
        actualizarEstadisticas();
        alert(`✅ Orden #${id} actualizada a: ${newStatus}`);
      }
    }

    function eliminarOrden(id) {
      if (confirm(`¿Estás seguro de que quieres eliminar la orden #${id}?`)) {
        orders = orders.filter(order => order.id !== id);
        cargarOrdenes();
        actualizarEstadisticas();
        alert(`✅ Orden #${id} eliminada correctamente.`);
      }
    }

    function exportarDatos() {
      if (orders.length === 0) {
        alert('❌ No hay órdenes para exportar.');
        return;
      }
      alert(`📤 Exportando ${orders.length} órdenes... Funcionalidad en desarrollo`);
    }
  </script>
</body>
</html>