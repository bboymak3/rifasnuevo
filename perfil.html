<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - Rifa 33</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .perfil-container {
            padding: 20px;
        }
        
        .perfil-header {
            display: flex;
            align-items: center;
            gap: 25px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            color: white;
            border: 5px solid white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .perfil-info h1 {
            margin: 0;
            color: #333;
        }
        
        .perfil-role {
            display: inline-block;
            padding: 5px 15px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            margin-top: 5px;
        }
        
        .perfil-role.admin {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .perfil-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card-perfil {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-icon-perfil {
            font-size: 30px;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .stat-value-perfil {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .stat-label-perfil {
            color: #666;
            font-size: 14px;
        }
        
        .perfil-tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .perfil-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .perfil-tab:hover {
            color: #2196f3;
        }
        
        .perfil-tab.active {
            color: #2196f3;
        }
        
        .perfil-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #2196f3;
        }
        
        .perfil-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .form-section h3 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group-perfil {
            display: flex;
            flex-direction: column;
        }
        
        .form-group-perfil label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #555;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group-perfil input,
        .form-group-perfil select {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .form-group-perfil input:focus,
        .form-group-perfil select:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .form-group-perfil input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }
        
        .password-toggle-perfil {
            position: relative;
        }
        
        .password-toggle-perfil button {
            position: absolute;
            right: 10px;
            top: 38px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
        }
        
        .danger-zone {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 10px;
            padding: 25px;
            margin-top: 40px;
        }
        
        .danger-zone h3 {
            color: #c53030;
            margin-bottom: 15px;
        }
        
        .danger-zone p {
            color: #718096;
            margin-bottom: 20px;
        }
        
        .qr-section {
            text-align: center;
            padding: 30px;
        }
        
        .qr-code {
            width: 200px;
            height: 200px;
            background: #f5f5f5;
            border-radius: 10px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            color: #333;
        }
        
        .referral-link {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .referral-link input {
            flex: 1;
            border: none;
            background: none;
            font-size: 14px;
            color: #333;
        }
        
        .referral-link button {
            padding: 8px 15px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .security-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .security-info h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        
        .security-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        
        .toggle-switch-perfil {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch-perfil input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider-perfil {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider-perfil:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider-perfil {
            background-color: #4caf50;
        }
        
        input:checked + .toggle-slider-perfil:before {
            transform: translateX(26px);
        }
        
        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .session-info h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        
        .session-info p {
            margin: 0;
            color: #666;
            font-size: 12px;
        }
        
        .session-current {
            background: #e8f5e9;
            border-color: #c8e6c9;
        }
        
        .btn-icon {
            padding: 8px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px;
        }
        
        .btn-icon:hover {
            background: #f8f9fa;
        }
        
        .btn-icon.edit:hover {
            color: #2196f3;
            border-color: #2196f3;
        }
        
        .btn-icon.delete:hover {
            color: #f44336;
            border-color: #f44336;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .perfil-header {
                flex-direction: column;
                text-align: center;
            }
            
            .perfil-tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }
            
            .perfil-tab {
                white-space: nowrap;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="user-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="user-info" id="sidebarUserInfo">
                    <h3>Cargando...</h3>
                    <p class="user-role">Usuario</p>
                </div>
                <div class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </div>
            </div>
            
            <nav class="sidebar-menu">
                <a href="dashboard.html" class="menu-item">
                    <i class="fas fa-home"></i>
                    <span>Inicio</span>
                </a>
                <a href="tickets.html" class="menu-item">
                    <i class="fas fa-ticket-alt"></i>
                    <span>Comprar Tickets</span>
                </a>
                <a href="recargas.html" class="menu-item">
                    <i class="fas fa-coins"></i>
                    <span>Recargar Puntos</span>
                </a>
                <a href="transferencias.html" class="menu-item">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Transferencias</span>
                </a>
                <a href="historial.html" class="menu-item">
                    <i class="fas fa-history"></i>
                    <span>Historial</span>
                </a>
                <a href="perfil.html" class="menu-item active">
                    <i class="fas fa-user-cog"></i>
                    <span>Mi Perfil</span>
                </a>
                
                <div class="menu-divider"></div>
                
                <a href="admin.html" class="menu-item admin-item" id="adminLink">
                    <i class="fas fa-crown"></i>
                    <span>Panel Admin</span>
                </a>
                
                <a href="#" class="menu-item logout-item" onclick="cerrarSesion()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Cerrar Sesión</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="points-display" id="sidebarPoints">
                    <i class="fas fa-coins"></i>
                    <div>
                        <span class="points-label">Tus Puntos</span>
                        <span class="points-value">0</span>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <div class="top-bar-left">
                    <h1><i class="fas fa-user-cog"></i> Mi Perfil</h1>
                    <p class="welcome-text">Gestiona tu cuenta y preferencias</p>
                </div>
                <div class="top-bar-right">
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-trigger">
                            <span id="userName">Cargando...</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="dropdown-menu">
                            <a href="perfil.html"><i class="fas fa-user"></i> Mi Perfil</a>
                            <a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
                            <div class="dropdown-divider"></div>
                            <a href="#" onclick="cerrarSesion()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="perfil-container">
                <!-- Encabezado del perfil -->
                <div class="perfil-header">
                    <div class="avatar-large" id="userAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="perfil-info">
                        <h1 id="userFullName">Cargando...</h1>
                        <p id="userEmail">Cargando...</p>
                        <span class="perfil-role" id="userRoleBadge">Usuario</span>
                        <p class="small" id="memberSince">Miembro desde: Cargando...</p>
                    </div>
                </div>
                
                <!-- Estadísticas -->
                <div class="perfil-stats">
                    <div class="stat-card-perfil">
                        <div class="stat-icon-perfil">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="stat-value-perfil" id="statPoints">0</div>
                        <div class="stat-label-perfil">Puntos Disponibles</div>
                    </div>
                    
                    <div class="stat-card-perfil">
                        <div class="stat-icon-perfil">
                            <i class="fas fa-ticket-alt"></i>
                        </div>
                        <div class="stat-value-perfil" id="statTickets">0</div>
                        <div class="stat-label-perfil">Tickets Comprados</div>
                    </div>
                    
                    <div class="stat-card-perfil">
                        <div class="stat-icon-perfil">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <div class="stat-value-perfil" id="statTransactions">0</div>
                        <div class="stat-label-perfil">Transacciones</div>
                    </div>
                    
                    <div class="stat-card-perfil">
                        <div class="stat-icon-perfil">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="stat-value-perfil" id="statDays">0</div>
                        <div class="stat-label-perfil">Días como Miembro</div>
                    </div>
                </div>
                
                <!-- Pestañas -->
                <div class="perfil-tabs">
                    <button class="perfil-tab active" onclick="showTab('informacion')">
                        <i class="fas fa-user"></i> Información Personal
                    </button>
                    <button class="perfil-tab" onclick="showTab('seguridad')">
                        <i class="fas fa-shield-alt"></i> Seguridad
                    </button>
                    <button class="perfil-tab" onclick="showTab('preferencias')">
                        <i class="fas fa-cog"></i> Preferencias
                    </button>
                    <button class="perfil-tab" onclick="showTab('referidos')">
                        <i class="fas fa-user-friends"></i> Programa de Referidos
                    </button>
                </div>
                
                <!-- Contenido de las pestañas -->
                <div class="perfil-content">
                    <!-- Información Personal -->
                    <div class="tab-pane active" id="informacionTab">
                        <div class="form-section">
                            <h3><i class="fas fa-id-card"></i> Datos Personales</h3>
                            <div class="form-row">
                                <div class="form-group-perfil">
                                    <label for="editNombre"><i class="fas fa-user"></i> Nombre Completo</label>
                                    <input type="text" id="editNombre" value="Cargando...">
                                </div>
                                <div class="form-group-perfil">
                                    <label for="editTelefono"><i class="fas fa-phone"></i> Teléfono</label>
                                    <input type="text" id="editTelefono" value="Cargando...">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group-perfil">
                                    <label for="editCedula"><i class="fas fa-id-card"></i> Cédula</label>
                                    <input type="text" id="editCedula" value="Cargando..." disabled>
                                </div>
                                <div class="form-group-perfil">
                                    <label for="editEmail"><i class="fas fa-envelope"></i> Correo Electrónico</label>
                                    <input type="email" id="editEmail" value="Cargando...">
                                </div>
                            </div>
                            <button class="btn-primary" onclick="updatePersonalInfo()">
                                <i class="fas fa-save"></i> Guardar Cambios
                            </button>
                        </div>
                        
                        <div class="form-section">
                            <h3><i class="fas fa-map-marker-alt"></i> Dirección</h3>
                            <div class="form-row">
                                <div class="form-group-perfil">
                                    <label for="editEstado">Estado</label>
                                    <select id="editEstado">
                                        <option value="">Seleccionar estado</option>
                                        <option value="DF">Distrito Federal</option>
                                        <option value="Amazonas">Amazonas</option>
                                        <option value="Anzoátegui">Anzoátegui</option>
                                        <option value="Apure">Apure</option>
                                        <option value="Aragua">Aragua</option>
                                        <option value="Barinas">Barinas</option>
                                        <option value="Bolívar">Bolívar</option>
                                        <option value="Carabobo">Carabobo</option>
                                        <option value="Cojedes">Cojedes</option>
                                        <option value="Delta Amacuro">Delta Amacuro</option>
                                        <option value="Falcón">Falcón</option>
                                        <option value="Guárico">Guárico</option>
                                        <option value="Lara">Lara</option>
                                        <option value="Mérida">Mérida</option>
                                        <option value="Miranda">Miranda</option>
                                        <option value="Monagas">Monagas</option>
                                        <option value="Nueva Esparta">Nueva Esparta</option>
                                        <option value="Portuguesa">Portuguesa</option>
                                        <option value="Sucre">Sucre</option>
                                        <option value="Táchira">Táchira</option>
                                        <option value="Trujillo">Trujillo</option>
                                        <option value="Vargas">Vargas</option>
                                        <option value="Yaracuy">Yaracuy</option>
                                        <option value="Zulia">Zulia</option>
                                    </select>
                                </div>
                                <div class="form-group-perfil">
                                    <label for="editCiudad">Ciudad</label>
                                    <input type="text" id="editCiudad" placeholder="Ej: Caracas">
                                </div>
                            </div>
                            <div class="form-group-perfil">
                                <label for="editDireccion">Dirección Completa</label>
                                <input type="text" id="editDireccion" placeholder="Ej: Av. Principal, Edificio, Piso, Apartamento">
                            </div>
                            <button class="btn-secondary" onclick="updateAddress()">
                                <i class="fas fa-map-marker-alt"></i> Actualizar Dirección
                            </button>
                        </div>
                    </div>
                    
                    <!-- Seguridad -->
                    <div class="tab-pane" id="seguridadTab">
                        <div class="form-section">
                            <h3><i class="fas fa-lock"></i> Cambiar Contraseña</h3>
                            <div class="form-row">
                                <div class="form-group-perfil">
                                    <label for="currentPassword">Contraseña Actual</label>
                                    <div class="password-toggle-perfil">
                                        <input type="password" id="currentPassword" placeholder="Ingresa tu contraseña actual">
                                        <button type="button" onclick="togglePassword('currentPassword')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group-perfil">
                                    <label for="newPassword">Nueva Contraseña</label>
                                    <div class="password-toggle-perfil">
                                        <input type="password" id="newPassword" placeholder="Mínimo 6 caracteres">
                                        <button type="button" onclick="togglePassword('newPassword')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="password-strength" id="passwordStrength"></div>
                                </div>
                                <div class="form-group-perfil">
                                    <label for="confirmNewPassword">Confirmar Nueva Contraseña</label>
                                    <div class="password-toggle-perfil">
                                        <input type="password" id="confirmNewPassword" placeholder="Repite la nueva contraseña">
                                        <button type="button" onclick="togglePassword('confirmNewPassword')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="password-match" id="passwordMatch"></div>
                                </div>
                            </div>
                            <button class="btn-primary" onclick="changePassword()">
                                <i class="fas fa-key"></i> Cambiar Contraseña
                            </button>
                        </div>
                        
                        <div class="form-section">
                            <h3><i class="fas fa-shield-alt"></i> Autenticación de Dos Factores</h3>
                            <div class="security-item">
                                <div class="security-info">
                                    <h4>Autenticación por SMS</h4>
                                    <p>Recibe un código por SMS al iniciar sesión</p>
                                </div>
                                <label class="toggle-switch-perfil">
                                    <input type="checkbox" id="twoFactorSMS">
                                    <span class="toggle-slider-perfil"></span>
                                </label>
                            </div>
                            
                            <div class="security-item">
                                <div class="security-info">
                                    <h4>Autenticación por Correo</h4>
                                    <p>Recibe un código por correo electrónico</p>
                                </div>
                                <label class="toggle-switch-perfil">
                                    <input type="checkbox" id="twoFactorEmail">
                                    <span class="toggle-slider-perfil"></span>
                                </label>
                            </div>
                            
                            <div class="security-item">
                                <div class="security-info">
                                    <h4>Autenticación por Aplicación</h4>
                                    <p>Usa Google Authenticator o similar</p>
                                </div>
                                <label class="toggle-switch-perfil">
                                    <input type="checkbox" id="twoFactorApp">
                                    <span class="toggle-slider-perfil"></span>
                                </label>
                            </div>
                            
                            <button class="btn-secondary" onclick="saveSecuritySettings()">
                                <i class="fas fa-save"></i> Guardar Configuración
                            </button>
                        </div>
                        
                        <div class="form-section">
                            <h3><i class="fas fa-desktop"></i> Sesiones Activas</h3>
                            <div id="activeSessions">
                                <div class="session-item session-current">
                                    <div class="session-info">
                                        <h4>Dispositivo Actual</h4>
                                        <p>Navegador: Chrome • Sistema: Windows</p>
                                        <p>IP: 192.168.1.100 • Última actividad: Ahora</p>
                                    </div>
                                    <div>
                                        <span class="badge current">ACTUAL</span>
                                    </div>
                                </div>
                            </div>
                            <button class="btn-secondary" onclick="terminateOtherSessions()">
                                <i class="fas fa-sign-out-alt"></i> Cerrar Otras Sesiones
                            </button>
                        </div>
                    </div>
                    
                    <!-- Preferencias -->
                    <div class="tab-pane" id="preferenciasTab">
                        <div class="form-section">
                            <h3><i class="fas fa-bell"></i> Notificaciones</h3>
                            <div class="security-item">
                                <div class="security-info">
                                    <h4>Notificaciones por Correo</h4>
                                    <p>Recibe notificaciones importantes por correo</p>
                                </div>
                                <label class="toggle-switch-perfil">
                                    <input type="checkbox" id="notifyEmail" checked>
                                    <span class="toggle-slider-perfil"></span>
                                </label>
                            </div>
                            
                            <div class="security-item">
                                <div class="security-info">
                                    <h4>Notificaciones por SMS</h4>
                                    <p>Recibe notificaciones por mensaje de texto</p>
                                </div>
                                <label class="toggle-switch-perfil">
                                    <input type="checkbox" id="notifySMS">
                                    <span class="toggle-slider-perfil"></span>
                                </label>
                            </div>
                            
                            <div class="security-item">
                                <div class="security-info">
                                    <h4>Notificaciones Push</h4>
                                    <p>Recibe notificaciones en el navegador</p>
                                </div>
                                <label class="toggle-switch-perfil">
                                    <input type="checkbox" id="notifyPush" checked>
                                    <span class="toggle-slider-perfil"></span>
                                </label>
                            </div>
                            
                            <h4 style="margin-top: 20px;">¿Qué deseas recibir?</h4>
                            <div class="form-row">
                                <div class="form-group-perfil">
                                    <label class="checkbox">
                                        <input type="checkbox" id="notifyPurchases" checked>
                                        <span>Compras de tickets</span>
                                    </label>
                                </div>
                                <div class="form-group-perfil">
                                    <label class="checkbox">
                                        <input type="checkbox" id="notifyRecharges" checked>
                                        <span>Recargas aprobadas</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group-perfil">
                                    <label class="checkbox">
                                        <input type="checkbox" id="notifyTransfers" checked>
                                        <span>Transferencias</span>
                                    </label>
                                </div>
                                <div class="form-group-perfil">
                                    <label class="checkbox">
                                        <input type="checkbox" id="notifyPromotions">
                                        <span>Promociones especiales</span>
                                    </label>
                                </div>
                            </div>
                            
                            <button class="btn-primary" onclick="saveNotificationSettings()">
                                <i class="fas fa-save"></i> Guardar Preferencias
                            </button>
                        </div>
                        
                        <div class="form-section">
                            <h3><i class="fas fa-palette"></i> Apariencia</h3>
                            <div class="form-row">
                                <div class="form-group-perfil">
                                    <label for="themeSelect">Tema</label>
                                    <select id="themeSelect" onchange="changeTheme()">
                                        <option value="light">Claro</option>
                                        <option value="dark">Oscuro</option>
                                        <option value="auto">Automático (según sistema)</option>
                                    </select>
                                </div>
                                <div class="form-group-perfil">
                                    <label for="languageSelect">Idioma</label>
                                    <select id="languageSelect">
                                        <option value="es">Español</option>
                                        <option value="en">English</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group-perfil">
                                    <label for="timezoneSelect">Zona Horaria</label>
                                    <select id="timezoneSelect">
                                        <option value="America/Caracas">Caracas (UTC-4)</option>
                                        <option value="America/New_York">New York (UTC-5)</option>
                                        <option value="America/Los_Angeles">Los Angeles (UTC-8)</option>
                                        <option value="Europe/Madrid">Madrid (UTC+1)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3><i class="fas fa-eye"></i> Privacidad</h3>
                            <div class="security-item">
                                <div class="security-info">
                                    <h4>Perfil Público</h4>
                                    <p>Permite que otros usuarios vean tu perfil</p>
                                </div>
                                <label class="toggle-switch-perfil">
                                    <input type="checkbox" id="privacyPublic">
                                    <span class="toggle-slider-perfil"></span>
                                </label>
                            </div>
                            
                            <div class="security-item">
                                <div class="security-info">
                                    <h4>Mostrar Tickets Comprados</h4>
                                    <p>Muestra los tickets que has comprado</p>
                                </div>
                                <label class="toggle-switch-perfil">
                                    <input type="checkbox" id="privacyTickets" checked>
                                    <span class="toggle-slider-perfil"></span>
                                </label>
                            </div>
                            
                            <div class="security-item">
                                <div class="security-info">
                                    <h4>Mostrar Puntos</h4>
                                    <p>Muestra tus puntos disponibles</p>
                                </div>
                                <label class="toggle-switch-perfil">
                                    <input type="checkbox" id="privacyPoints">
                                    <span class="toggle-slider-perfil"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Programa de Referidos -->
                    <div class="tab-pane" id="referidosTab">
                        <div class="form-section">
                            <h3><i class="fas fa-user-friends"></i> Invita a Tus Amigos</h3>
                            <p>Comparte tu enlace de referido y gana puntos cuando tus amigos se registren y realicen su primera recarga.</p>
                            
                            <div class="qr-section">
                                <div class="qr-code">
                                    <i class="fas fa-qrcode"></i>
                                </div>
                                <p>Escanea este código para compartir</p>
                            </div>
                            
                            <div class="referral-link">
                                <input type="text" id="referralLink" value="https://rifa33.com/ref/ABC123" readonly>
                                <button onclick="copyReferralLink()">
                                    <i class="fas fa-copy"></i> Copiar
                                </button>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group-perfil">
                                    <label>Tu Código de Referido</label>
                                    <input type="text" id="referralCode" value="ABC123" readonly>
                                </div>
                                <div class="form-group-perfil">
                                    <label>Puntos por Referido</label>
                                    <input type="text" value="100 puntos" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3><i class="fas fa-chart-line"></i> Estadísticas de Referidos</h3>
                            <div class="perfil-stats">
                                <div class="stat-card-perfil">
                                    <div class="stat-icon-perfil">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div class="stat-value-perfil" id="refTotal">0</div>
                                    <div class="stat-label-perfil">Referidos Totales</div>
                                </div>
                                
                                <div class="stat-card-perfil">
                                    <div class="stat-icon-perfil">
                                        <i class="fas fa-user-check"></i>
                                    </div>
                                    <div class="stat-value-perfil" id="refActive">0</div>
                                    <div class="stat-label-perfil">Referidos Activos</div>
                                </div>
                                
                                <div class="stat-card-perfil">
                                    <div class="stat-icon-perfil">
                                        <i class="fas fa-coins"></i>
                                    </div>
                                    <div class="stat-value-perfil" id="refPoints">0</div>
                                    <div class="stat-label-perfil">Puntos Ganados</div>
                                </div>
                                


                                <!-- CONTINUACIÓN DEL CÓDIGO ANTERIOR - AGREGANDO LO QUE FALTA -->

                                <div class="stat-card-perfil">
                                    <div class="stat-icon-perfil">
                                        <i class="fas fa-money-bill-wave"></i>
                                    </div>
                                    <div class="stat-value-perfil" id="refEarnings">$0</div>
                                    <div class="stat-label-perfil">Ganancias Totales</div>
                                </div>
                            </div>
                            
                            <div class="table-container" style="margin-top: 20px;">
                                <h4>Lista de Referidos</h4>
                                <table style="width: 100%; margin-top: 15px;">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Fecha Registro</th>
                                            <th>Estado</th>
                                            <th>Puntos Ganados</th>
                                        </tr>
                                    </thead>
                                    <tbody id="referralsList">
                                        <tr>
                                            <td colspan="4" class="empty-state">No tienes referidos aún</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <button class="btn-primary" onclick="shareReferral()" style="margin-top: 20px;">
                                <i class="fas fa-share-alt"></i> Compartir Enlace
                            </button>
                        </div>
                    </div>
                    
                    <!-- Zona de Peligro (FALTABA ESTA SECCIÓN) -->
                    <div class="danger-zone">
                        <h3><i class="fas fa-exclamation-triangle"></i> Zona de Peligro</h3>
                        <p>Estas acciones son irreversibles. Procede con precaución.</p>
                        
                        <div class="danger-actions">
                            <div class="danger-action">
                                <h4>Eliminar Cuenta</h4>
                                <p>Tu cuenta y todos tus datos serán eliminados permanentemente.</p>
                                <button class="btn-danger" onclick="showDeleteAccountModal()">
                                    <i class="fas fa-trash"></i> Eliminar Mi Cuenta
                                </button>
                            </div>
                            
                            <div class="danger-action" style="margin-top: 20px;">
                                <h4>Exportar Mis Datos</h4>
                                <p>Descarga todos tus datos personales en formato PDF.</p>
                                <button class="btn-warning" onclick="exportMyData()">
                                    <i class="fas fa-download"></i> Exportar Mis Datos
                                </button>
                            </div>
                            
                            <div class="danger-action" style="margin-top: 20px;">
                                <h4>Solicitar Verificación</h4>
                                <p>Envía una solicitud para verificar tu identidad.</p>
                                <button class="btn-info" onclick="requestVerification()">
                                    <i class="fas fa-check-circle"></i> Solicitar Verificación
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal para eliminar cuenta -->
    <div class="modal" id="deleteAccountModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Eliminar Cuenta</h3>
                <button class="close-btn" onclick="closeDeleteAccountModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="warning-message">
                    <i class="fas fa-exclamation-circle" style="color: #f44336; font-size: 40px; margin-bottom: 15px;"></i>
                    <h4>¡Esta acción es permanente!</h4>
                    <p>Al eliminar tu cuenta:</p>
                    <ul>
                        <li>Todos tus datos personales serán eliminados</li>
                        <li>Perderás todos tus puntos y tickets</li>
                        <li>Tu historial de transacciones será borrado</li>
                        <li>No podrás recuperar tu cuenta</li>
                    </ul>
                    <p>Para confirmar, escribe "<strong>ELIMINAR CUENTA</strong>" en el siguiente campo:</p>
                    <input type="text" id="deleteConfirmation" placeholder="ELIMINAR CUENTA" style="width: 100%; padding: 10px; margin: 10px 0;">
                    <div class="form-group-perfil">
                        <label class="checkbox">
                            <input type="checkbox" id="confirmDelete">
                            <span>Entiendo que esta acción es irreversible</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeDeleteAccountModal()">Cancelar</button>
                <button class="btn-danger" id="confirmDeleteBtn" onclick="deleteAccount()" disabled>
                    <i class="fas fa-trash"></i> Eliminar Cuenta Permanentemente
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal para cambio exitoso -->
    <div class="modal" id="successModal">
        <div class="modal-content">
            <div class="modal-body" style="text-align: center; padding: 40px;">
                <div class="success-icon">
                    <i class="fas fa-check-circle" style="color: #4caf50; font-size: 60px;"></i>
                </div>
                <h3 id="successTitle">¡Éxito!</h3>
                <p id="successMessage">Los cambios se han guardado correctamente.</p>
                <button class="btn-primary" onclick="closeSuccessModal()">
                    <i class="fas fa-check"></i> Aceptar
                </button>
            </div>
        </div>
    </div>
    
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Variables globales
        let usuarioActual = null;
        let perfilData = {};
        
        // Inicializar página
        document.addEventListener('DOMContentLoaded', async () => {
            const usuario = window.verificarAutenticacion();
            if (!usuario) return;
            
            usuarioActual = usuario;
            await initPerfil();
            setupUserDropdown();
            setupEventListeners();
            
            // Actualizar información del usuario
            updateUserInfo(usuario);
            
            // Mostrar admin link si es admin
            if (usuario.role === 'admin') {
                document.getElementById('adminLink').style.display = 'flex';
            }
        });
        
        async function initPerfil() {
            try {
                // Cargar datos del perfil
                await loadPerfilData();
                
                // Cargar estadísticas
                await loadPerfilStats();
                
                // Cargar sesiones activas
                await loadActiveSessions();
                
                // Cargar referidos
                await loadReferrals();
                
                // Configurar validaciones
                setupValidations();
                
            } catch (error) {
                console.error('Error al inicializar perfil:', error);
                showNotification('Error al cargar datos del perfil', 'error');
            }
        }
        
        function updateUserInfo(usuario) {
            // Actualizar información en sidebar
            document.getElementById('sidebarUserInfo').innerHTML = `
                <h3>${usuario.nombre}</h3>
                <p class="user-role">${usuario.role === 'admin' ? 'Administrador' : 'Usuario'}</p>
            `;
            
            document.getElementById('userName').textContent = usuario.nombre;
            document.getElementById('sidebarPoints').innerHTML = `
                <i class="fas fa-coins"></i>
                <div>
                    <span class="points-label">Tus Puntos</span>
                    <span class="points-value">${usuario.puntos}</span>
                </div>
            `;
            
            // Actualizar información principal
            document.getElementById('userFullName').textContent = usuario.nombre;
            document.getElementById('userEmail').textContent = usuario.correo || 'No especificado';
            document.getElementById('userRoleBadge').textContent = usuario.role === 'admin' ? 'Administrador' : 'Usuario';
            document.getElementById('userRoleBadge').className = `perfil-role ${usuario.role === 'admin' ? 'admin' : ''}`;
            
            // Actualizar campos del formulario
            document.getElementById('editNombre').value = usuario.nombre;
            document.getElementById('editTelefono').value = usuario.telefono || '';
            document.getElementById('editCedula').value = usuario.cedula || '';
            document.getElementById('editEmail').value = usuario.correo || '';
        }
        
        async function loadPerfilData() {
            try {
                // Cargar datos adicionales del usuario
                const usuario = await window.obtenerUno(`
                    SELECT nombre, telefono, cedula, correo, puntos, role, created_at,
                           estado, ciudad, direccion, codigo_referido, 
                           notificaciones_email, notificaciones_sms, notificaciones_push,
                           tema, idioma, zona_horaria
                    FROM users WHERE id = ${usuarioActual.id}
                `);
                
                if (usuario) {
                    perfilData = usuario;
                    
                    // Actualizar fecha de miembro
                    const memberSince = new Date(usuario.created_at);
                    const days = Math.floor((new Date() - memberSince) / (1000 * 60 * 60 * 24));
                    document.getElementById('memberSince').textContent = 
                        `Miembro desde: ${memberSince.toLocaleDateString()} (${days} días)`;
                    document.getElementById('statDays').textContent = days;
                    
                    // Actualizar dirección si existe
                    if (usuario.estado) {
                        document.getElementById('editEstado').value = usuario.estado;
                    }
                    if (usuario.ciudad) {
                        document.getElementById('editCiudad').value = usuario.ciudad;
                    }
                    if (usuario.direccion) {
                        document.getElementById('editDireccion').value = usuario.direccion;
                    }
                    
                    // Actualizar preferencias
                    if (usuario.tema) {
                        document.getElementById('themeSelect').value = usuario.tema;
                    }
                    if (usuario.idioma) {
                        document.getElementById('languageSelect').value = usuario.idioma;
                    }
                    if (usuario.zona_horaria) {
                        document.getElementById('timezoneSelect').value = usuario.zona_horaria;
                    }
                    
                    // Actualizar notificaciones
                    if (usuario.notificaciones_email !== undefined) {
                        document.getElementById('notifyEmail').checked = usuario.notificaciones_email;
                    }
                    if (usuario.notificaciones_sms !== undefined) {
                        document.getElementById('notifySMS').checked = usuario.notificaciones_sms;
                    }
                    if (usuario.notificaciones_push !== undefined) {
                        document.getElementById('notifyPush').checked = usuario.notificaciones_push;
                    }
                    
                    // Actualizar código de referido
                    if (usuario.codigo_referido) {
                        const referralCode = usuario.codigo_referido;
                        document.getElementById('referralCode').value = referralCode;
                        document.getElementById('referralLink').value = 
                            `https://rifa33.com/ref/${referralCode}`;
                    }
                }
                
            } catch (error) {
                console.error('Error al cargar datos del perfil:', error);
            }
        }
        
        async function loadPerfilStats() {
            try {
                const stats = await window.obtenerDatos(`
                    SELECT 
                        (SELECT puntos FROM users WHERE id = ${usuarioActual.id}) as puntos,
                        (SELECT COUNT(*) FROM tickets WHERE user_id = ${usuarioActual.id} AND estado = 'vendido') as tickets,
                        (SELECT COUNT(*) FROM transacciones WHERE user_id = ${usuarioActual.id}) as transacciones
                `);
                
                if (stats && stats.length > 0) {
                    const data = stats[0];
                    
                    document.getElementById('statPoints').textContent = data.puntos || 0;
                    document.getElementById('statTickets').textContent = data.tickets || 0;
                    document.getElementById('statTransactions').textContent = data.transacciones || 0;
                }
                
            } catch (error) {
                console.error('Error al cargar estadísticas:', error);
            }
        }
        
        async function loadActiveSessions() {
            try {
                // En un sistema real, aquí cargarías las sesiones activas desde el servidor
                // Por ahora simularemos datos
                const sessions = [
                    {
                        device: 'Chrome en Windows',
                        ip: '192.168.1.100',
                        lastActive: 'Ahora mismo',
                        current: true
                    },
                    {
                        device: 'Firefox en Android',
                        ip: '192.168.1.101',
                        lastActive: 'Hace 2 horas',
                        current: false
                    }
                ];
                
                const container = document.getElementById('activeSessions');
                let html = '';
                
                sessions.forEach(session => {
                    html += `
                        <div class="session-item ${session.current ? 'session-current' : ''}">
                            <div class="session-info">
                                <h4>${session.device}</h4>
                                <p>IP: ${session.ip} • Última actividad: ${session.lastActive}</p>
                            </div>
                            <div>
                                ${session.current ? '<span class="badge current">ACTUAL</span>' : ''}
                                ${!session.current ? `
                                    <button class="btn-icon delete" onclick="terminateSession('${session.ip}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error al cargar sesiones:', error);
            }
        }
        
        async function loadReferrals() {
            try {
                // Obtener referidos del usuario
                const referrals = await window.obtenerDatos(`
                    SELECT u.nombre, u.created_at, u.puntos, 
                           CASE WHEN u.puntos > 0 THEN 'Activo' ELSE 'Inactivo' END as estado,
                           FLOOR(u.puntos * 0.1) as puntos_ganados
                    FROM users u
                    WHERE u.referido_por = ${usuarioActual.id}
                    ORDER BY u.created_at DESC
                `);
                
                // Actualizar estadísticas de referidos
                if (referrals && referrals.length > 0) {
                    const totalReferrals = referrals.length;
                    const activeReferrals = referrals.filter(r => r.estado === 'Activo').length;
                    const totalPoints = referrals.reduce((sum, r) => sum + (r.puntos_ganados || 0), 0);
                    const totalEarnings = totalPoints / 100; // Suponiendo 100 puntos = $1
                    
                    document.getElementById('refTotal').textContent = totalReferrals;
                    document.getElementById('refActive').textContent = activeReferrals;
                    document.getElementById('refPoints').textContent = totalPoints;
                    document.getElementById('refEarnings').textContent = `$${totalEarnings.toFixed(2)}`;
                    
                    // Actualizar lista de referidos
                    const tbody = document.getElementById('referralsList');
                    let html = '';
                    
                    referrals.forEach(ref => {
                        const fecha = new Date(ref.created_at).toLocaleDateString();
                        html += `
                            <tr>
                                <td>${ref.nombre}</td>
                                <td>${fecha}</td>
                                <td><span class="status-badge ${ref.estado === 'Activo' ? 'status-approved' : 'status-pending'}">${ref.estado}</span></td>
                                <td>${ref.puntos_ganados} puntos</td>
                            </tr>
                        `;
                    });
                    
                    tbody.innerHTML = html;
                }
                
            } catch (error) {
                console.error('Error al cargar referidos:', error);
            }
        }
        
        function setupValidations() {
            // Validación de fortaleza de contraseña
            document.getElementById('newPassword').addEventListener('input', function() {
                const password = this.value;
                const strengthDiv = document.getElementById('passwordStrength');
                
                if (password.length === 0) {
                    strengthDiv.innerHTML = '';
                    return;
                }
                
                let strength = 0;
                let message = '';
                let color = '';
                
                if (password.length >= 8) strength++;
                if (/[A-Z]/.test(password)) strength++;
                if (/[0-9]/.test(password)) strength++;
                if (/[^A-Za-z0-9]/.test(password)) strength++;
                
                switch(strength) {
                    case 1:
                        message = 'Débil';
                        color = '#e53e3e';
                        break;
                    case 2:
                        message = 'Regular';
                        color = '#ed8936';
                        break;
                    case 3:
                        message = 'Buena';
                        color = '#38a169';
                        break;
                    case 4:
                        message = 'Excelente';
                        color = '#276749';
                        break;
                }
                
                strengthDiv.innerHTML = `<span style="color:${color}">${message}</span>`;
            });
            
            // Validación de coincidencia de contraseñas
            document.getElementById('confirmNewPassword').addEventListener('input', function() {
                const password = document.getElementById('newPassword').value;
                const confirm = this.value;
                const matchDiv = document.getElementById('passwordMatch');
                
                if (confirm.length === 0) {
                    matchDiv.innerHTML = '';
                    return;
                }
                
                if (password === confirm) {
                    matchDiv.innerHTML = '<span style="color:#38a169">✓ Coinciden</span>';
                } else {
                    matchDiv.innerHTML = '<span style="color:#e53e3e">✗ No coinciden</span>';
                }
            });
            
            // Validación para eliminar cuenta
            document.getElementById('deleteConfirmation').addEventListener('input', function() {
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                const confirmation = this.value.toUpperCase();
                const confirmCheck = document.getElementById('confirmDelete').checked;
                
                confirmBtn.disabled = !(confirmation === 'ELIMINAR CUENTA' && confirmCheck);
            });
            
            document.getElementById('confirmDelete').addEventListener('change', function() {
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                const confirmation = document.getElementById('deleteConfirmation').value.toUpperCase();
                
                confirmBtn.disabled = !(confirmation === 'ELIMINAR CUENTA' && this.checked);
            });
        }
        
        function setupEventListeners() {
            // Toggle sidebar en móviles
            document.getElementById('sidebarToggle').addEventListener('click', () => {
                document.querySelector('.sidebar').classList.toggle('collapsed');
            });
        }
        
        function showTab(tabName) {
            // Ocultar todas las pestañas
            document.querySelectorAll('.tab-pane').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Desactivar todos los botones
            document.querySelectorAll('.perfil-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar pestaña seleccionada
            document.getElementById(`${tabName}Tab`).classList.add('active');
            
            // Activar botón
            event.target.closest('.perfil-tab').classList.add('active');
            
            // Cargar datos de la pestaña si es necesario
            if (tabName === 'referidos') {
                loadReferrals();
            }
        }
        
        async function updatePersonalInfo() {
            const nombre = document.getElementById('editNombre').value.trim();
            const telefono = document.getElementById('editTelefono').value.trim();
            const correo = document.getElementById('editEmail').value.trim();
            
            if (!nombre || !telefono || !correo) {
                showNotification('Por favor completa todos los campos', 'error');
                return;
            }
            
            if (!correo.includes('@')) {
                showNotification('Ingresa un correo electrónico válido', 'error');
                return;
            }
            
            try {
                await window.ejecutarComando(`
                    UPDATE users 
                    SET nombre = '${nombre}',
                        telefono = '${telefono}',
                        correo = '${correo}',
                        updated_at = CURRENT_TIMESTAMP
                    WHERE id = ${usuarioActual.id}
                `);
                
                // Actualizar usuario en localStorage
                usuarioActual.nombre = nombre;
                usuarioActual.telefono = telefono;
                usuarioActual.correo = correo;
                localStorage.setItem('usuarioRifa', JSON.stringify(usuarioActual));
                
                // Actualizar UI
                updateUserInfo(usuarioActual);
                
                showSuccessModal('Datos Actualizados', 'Tu información personal ha sido actualizada exitosamente.');
                
            } catch (error) {
                console.error('Error al actualizar información:', error);
                showNotification('Error al actualizar información', 'error');
            }
        }
        
        async function updateAddress() {
            const estado = document.getElementById('editEstado').value;
            const ciudad = document.getElementById('editCiudad').value.trim();
            const direccion = document.getElementById('editDireccion').value.trim();
            
            if (!estado || !ciudad) {
                showNotification('Por favor completa estado y ciudad', 'error');
                return;
            }
            
            try {
                await window.ejecutarComando(`
                    UPDATE users 
                    SET estado = '${estado}',
                        ciudad = '${ciudad}',
                        direccion = '${direccion}',
                        updated_at = CURRENT_TIMESTAMP
                    WHERE id = ${usuarioActual.id}
                `);
                
                showSuccessModal('Dirección Actualizada', 'Tu dirección ha sido actualizada exitosamente.');
                
            } catch (error) {
                console.error('Error al actualizar dirección:', error);
                showNotification('Error al actualizar dirección', 'error');
            }
        }
        
        async function changePassword() {
            const currentPass = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmNewPassword').value;
            
            if (!currentPass || !newPass || !confirmPass) {
                showNotification('Por favor completa todos los campos', 'error');
                return;
            }
            
            if (newPass.length < 6) {
                showNotification('La nueva contraseña debe tener al menos 6 caracteres', 'error');
                return;
            }
            
            if (newPass !== confirmPass) {
                showNotification('Las contraseñas no coinciden', 'error');
                return;
            }
            
            // En un sistema real, aquí verificarías la contraseña actual con el hash
            // Por ahora hacemos una verificación simple
            try {
                // Generar nuevo hash (en producción usar bcrypt)
                const newHash = `$2a$10$${btoa(newPass).substring(0, 50)}...`;
                
                await window.ejecutarComando(`
                    UPDATE users 
                    SET password_hash = '${newHash}',
                        updated_at = CURRENT_TIMESTAMP
                    WHERE id = ${usuarioActual.id}
                `);
                
                // Limpiar campos
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmNewPassword').value = '';
                
                showSuccessModal('Contraseña Cambiada', 'Tu contraseña ha sido actualizada exitosamente.');
                
            } catch (error) {
                console.error('Error al cambiar contraseña:', error);
                showNotification('Error al cambiar contraseña', 'error');
            }
        }
        
        async function saveSecuritySettings() {
            const twoFactorSMS = document.getElementById('twoFactorSMS').checked;
            const twoFactorEmail = document.getElementById('twoFactorEmail').checked;
            const twoFactorApp = document.getElementById('twoFactorApp').checked;
            
            try {
                // En un sistema real, aquí guardarías estas configuraciones en la base de datos
                console.log('Configuración de seguridad guardada:', {
                    twoFactorSMS,
                    twoFactorEmail,
                    twoFactorApp
                });
                
                showSuccessModal('Configuración Guardada', 'Tu configuración de seguridad ha sido guardada.');
                
            } catch (error) {
                console.error('Error al guardar configuración:', error);
                showNotification('Error al guardar configuración', 'error');
            }
        }
        
        async function saveNotificationSettings() {
            const notifyEmail = document.getElementById('notifyEmail').checked;
            const notifySMS = document.getElementById('notifySMS').checked;
            const notifyPush = document.getElementById('notifyPush').checked;
            const notifyPurchases = document.getElementById('notifyPurchases').checked;
            const notifyRecharges = document.getElementById('notifyRecharges').checked;
            const notifyTransfers = document.getElementById('notifyTransfers').checked;
            const notifyPromotions = document.getElementById('notifyPromotions').checked;
            
            try {
                await window.ejecutarComando(`
                    UPDATE users 
                    SET notificaciones_email = ${notifyEmail ? 1 : 0},
                        notificaciones_sms = ${notifySMS ? 1 : 0},
                        notificaciones_push = ${notifyPush ? 1 : 0},
                        updated_at = CURRENT_TIMESTAMP
                    WHERE id = ${usuarioActual.id}
                `);
                
                // Guardar preferencias específicas en localStorage
                const preferences = {
                    notifyPurchases,
                    notifyRecharges,
                    notifyTransfers,
                    notifyPromotions
                };
                localStorage.setItem('userPreferences', JSON.stringify(preferences));
                
                showSuccessModal('Preferencias Guardadas', 'Tus preferencias de notificaciones han sido guardadas.');
                
            } catch (error) {
                console.error('Error al guardar preferencias:', error);
                showNotification('Error al guardar preferencias', 'error');
            }
        }
        
        function changeTheme() {
            const theme = document.getElementById('themeSelect').value;
            
            // Aplicar tema
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            // En un sistema real, guardarías esto en la base de datos
            console.log('Tema cambiado a:', theme);
        }
        
        async function terminateOtherSessions() {
            if (confirm('¿Estás seguro de cerrar todas las demás sesiones? Esto no cerrará tu sesión actual.')) {
                // En un sistema real, aquí invalidarías otros tokens de sesión
                showSuccessModal('Sesiones Cerradas', 'Todas las demás sesiones han sido terminadas.');
                
                // Recargar sesiones
                await loadActiveSessions();
            }
        }
        
        function terminateSession(ip) {
            if (confirm(`¿Terminar sesión desde ${ip}?`)) {
                // En un sistema real, aquí invalidarías este token específico
                showNotification(`Sesión desde ${ip} terminada`, 'info');
                
                // Recargar sesiones
                loadActiveSessions();
            }
        }
        
        function copyReferralLink() {
            const referralLink = document.getElementById('referralLink');
            referralLink.select();
            referralLink.setSelectionRange(0, 99999); // Para móviles
            
            navigator.clipboard.writeText(referralLink.value)
                .then(() => {
                    showNotification('Enlace copiado al portapapeles', 'success');
                })
                .catch(err => {
                    console.error('Error al copiar:', err);
                    showNotification('Error al copiar enlace', 'error');
                });
        }
        
        function shareReferral() {
            const referralLink = document.getElementById('referralLink').value;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Únete a Rifa 33',
                    text: 'Regístrate en Rifa 33 usando mi enlace de referido y gana puntos gratis!',
                    url: referralLink
                })
                .then(() => console.log('Compartido exitosamente'))
                .catch(error => console.log('Error al compartir:', error));
            } else {
                // Fallback para navegadores que no soportan Web Share API
                copyReferralLink();
            }
        }
        
        function showDeleteAccountModal() {
            document.getElementById('deleteAccountModal').style.display = 'flex';
        }
        
        function closeDeleteAccountModal() {
            document.getElementById('deleteAccountModal').style.display = 'none';
            document.getElementById('deleteConfirmation').value = '';
            document.getElementById('confirmDelete').checked = false;
            document.getElementById('confirmDeleteBtn').disabled = true;
        }
        
        async function deleteAccount() {
            try {
                // Aquí iría la lógica para eliminar la cuenta
                // Por seguridad, esto debería ser manejado por el backend
                
                // Simulación de eliminación
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                showSuccessModal('Cuenta Eliminada', 'Tu cuenta ha sido eliminada exitosamente. Serás redirigido al inicio.');
                
                // Cerrar sesión y redirigir
                setTimeout(() => {
                    window.cerrarSesion();
                    window.location.href = 'index.html';
                }, 2000);
                
            } catch (error) {
                console.error('Error al eliminar cuenta:', error);
                showNotification('Error al eliminar cuenta', 'error');
            }
        }
        
        function exportMyData() {
            showNotification('Generando archivo de datos...', 'info');
            
            // Simulación de exportación
            setTimeout(() => {
                const data = {
                    usuario: usuarioActual,
                    perfil: perfilData,
                    fecha: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `datos_personales_${usuarioActual.id}_${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showNotification('Datos exportados exitosamente', 'success');
            }, 1500);
        }
        
        function requestVerification() {
            showNotification('Solicitud de verificación enviada', 'info');
            // En un sistema real, aquí enviarías una solicitud al administrador
        }
        
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = input.parentNode.querySelector('button');
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }
        
        function showSuccessModal(title, message) {
            document.getElementById('successTitle').textContent = title;
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successModal').style.display = 'flex';
        }
        
        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                  type === 'error' ? 'exclamation-circle' : 
                                  type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        function setupUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            const trigger = dropdown.querySelector('.dropdown-trigger');
            
            trigger.addEventListener('click', () => {
                dropdown.classList.toggle('active');
            });
            
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target)) {
                    dropdown.classList.remove('active');
                }
            });
        }
    </script>
</body>
</html>